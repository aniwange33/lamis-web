import * as tslib_1 from "tslib";
import { Component, ViewChild } from '@angular/core';
import { LaboratoryService } from '../services/laboratory.service';
import { NotificationService } from '@alfresco/adf-core';
import { ActivatedRoute } from '@angular/router';
import { MatButton, MatProgressBar } from '@angular/material';
import { ColumnMode } from '@swimlane/ngx-datatable';
import * as moment_ from 'moment';
import { AppLoaderService, entityCompare } from '@lamis/web-core';
import { TdDialogService } from '@covalent/core';
var moment = moment_;
var LaboratoryEditComponent = /** @class */ (function () {
    function LaboratoryEditComponent(laboratoryService, notification, appLoaderService, _dialogService, activatedRoute) {
        this.laboratoryService = laboratoryService;
        this.notification = notification;
        this.appLoaderService = appLoaderService;
        this._dialogService = _dialogService;
        this.activatedRoute = activatedRoute;
        this.entity = {};
        this.maxNextVisit = moment().add(200, 'days');
        this.categories = [];
        this.tests = [];
        this.selectedTests = [];
        this.error = false;
        this.tomorrow = moment().add(1, 'days');
        this.today = moment();
        this.ColumnMode = ColumnMode;
        this.editing = {};
        this.errors = {};
        this.rows = [];
        this.labTestIds = new Set();
        this.visitDates = [];
    }
    LaboratoryEditComponent.prototype.createEntity = function () {
        return {};
    };
    LaboratoryEditComponent.prototype.ngOnInit = function () {
        var _this = this;
        this.isSaving = false;
        this.activatedRoute.data.subscribe(function (_a) {
            var entity = _a.entity;
            _this.entity = !!entity && entity.body ? entity.body : entity;
            if (_this.entity === undefined) {
                _this.entity = _this.createEntity();
            }
            var patientId = _this.activatedRoute.snapshot.paramMap.get('patientId');
            _this.laboratoryService.getPatient(patientId).subscribe(function (res) {
                _this.entity.patient = res;
                _this.patient = res;
                _this.dateRegistration = res.dateRegistration;
                _this.entity.facility = res.facility;
                _this.laboratoryService.getVisitDatesByPatient(res.id).subscribe(function (res1) {
                    _this.visitDates = res1;
                });
                _this.minReportedDate = _this.entity.patient.dateRegistration.clone().add(0, 'days');
                _this.minAssayDate = _this.entity.patient.dateRegistration.clone().add(0, 'days');
                if (_this.entity.id) {
                    _this.updateMinDates();
                }
            });
            if (_this.entity.id) {
                _this.updateMinDates();
                _this.rows = tslib_1.__spread(_this.entity.lines.map(function (r) {
                    _this.laboratoryService.getLabTestById(r.lab_test_id).subscribe(function (res) {
                        r.description = res.description;
                        r.unit = res.unit;
                        if (!_this.tests.map(function (r1) { return r1.id; }).includes(r.lab_test_id)) {
                            _this.tests.push(res);
                            _this.selectedTests.push(res);
                            _this.tests = tslib_1.__spread(_this.tests);
                            _this.selectedTests = tslib_1.__spread(_this.selectedTests);
                        }
                        r.result = r.result || '';
                    });
                    return r;
                }));
                _this.rows = tslib_1.__spread(_this.rows);
            }
            _this.laboratoryService.laboratoryCategories().subscribe(function (res) { return _this.categories = res; });
        });
    };
    LaboratoryEditComponent.prototype.updateMinDates = function () {
        this.minAssayDate = this.entity.dateSampleCollected.clone().add(0, 'days');
        if (this.entity.dateAssay) {
            this.minReportedDate = this.entity.dateAssay.clone().add(0, 'days');
        }
        else {
            this.minReportedDate = this.entity.dateSampleCollected.clone().add(1, 'days');
        }
    };
    LaboratoryEditComponent.prototype.filterDates = function (date) {
        var exists = false;
        this.visitDates.forEach(function (d) {
            if (date.diff(d, 'days') === 0) {
                exists = true;
            }
        });
        return (this.entity.id && date.diff(this.entity.dateSampleCollected, 'days') === 0) || !exists;
    };
    LaboratoryEditComponent.prototype.previousState = function () {
        window.history.back();
    };
    LaboratoryEditComponent.prototype.entityCompare = function (e1, e2) {
        return entityCompare(e1, e2);
    };
    LaboratoryEditComponent.prototype.sampleDateChanged = function (date) {
        this.minAssayDate = date.clone().add(0, 'days');
    };
    LaboratoryEditComponent.prototype.assayDateChanged = function (date) {
        this.minReportedDate = date.clone().add(0, 'days');
    };
    LaboratoryEditComponent.prototype.edit = function (rowIndex) {
        this.editing[rowIndex + ''] = true;
    };
    LaboratoryEditComponent.prototype.save = function () {
        var _this = this;
        this.isSaving = true;
        var abort = false;
        // this.progressBar.mode = 'indeterminate';
        this.rows = this.rows.map(function (line) {
            if (line.lab_test_id === 16 && !line.indication) {
                _this._dialogService.openAlert({
                    title: 'Indication is required',
                    message: 'Please select indication for Viral Load Test',
                    disableClose: true
                });
                _this.isSaving = false;
                abort = true;
            }
            if (line.lab_test_id !== 16 && line.indication) {
                line.indication = null;
            }
            if (_this.entity.dateAssay && !line.result) {
                _this._dialogService.openAlert({
                    title: 'Result is required',
                    message: 'Please provide test result',
                    disableClose: true
                });
                _this.isSaving = false;
                abort = true;
            }
            if (line.result && !_this.entity.dateAssay) {
                _this.isSaving = false;
                abort = true;
                _this._dialogService.openAlert({
                    title: 'Form not complete',
                    message: 'Please provide Date of Test Assay',
                    disableClose: true
                });
            }
            var result = parseInt(line.result, 10);
            if ((line.lab_test_id === 16 || line.lab_test_id === 1) && _this.entity.dateAssay) {
                if (!result) {
                    var zero = false;
                    if (result === 0) {
                        zero = true;
                    }
                    if (!zero) {
                        _this._dialogService.openAlert({
                            title: 'Result is invalid',
                            message: 'Please provide numeric result for test',
                            disableClose: true
                        });
                        _this.isSaving = false;
                        abort = true;
                    }
                }
                else if (result < 0) {
                    _this._dialogService.openAlert({
                        title: 'Result is invalid',
                        message: 'Please provide value >=0 for test result',
                        disableClose: true
                    });
                    _this.isSaving = false;
                    abort = true;
                }
                else {
                    line.result = result.toString();
                }
            }
            if (!!line.result && line.result.toUpperCase() === 'NAN') {
                line.result = null;
            }
            return line;
        });
        if (abort) {
            return;
        }
        this.appLoaderService.open('Saving request...');
        this.entity.lines = this.rows;
        if (this.entity.id !== undefined) {
            this.subscribeToSaveResponse(this.laboratoryService.update(this.entity));
        }
        else {
            this.subscribeToSaveResponse(this.laboratoryService.create(this.entity));
        }
    };
    LaboratoryEditComponent.prototype.categoryChanged = function (type) {
        var _this = this;
        this.laboratoryService.labTestsByCategory(type.id).subscribe(function (res) {
            res.forEach(function (labTest) {
                if (!_this.tests.map(function (r) { return r.id; }).includes(labTest.id)) {
                    _this.tests.push(labTest);
                    _this.tests = tslib_1.__spread(_this.tests);
                }
            });
        });
    };
    LaboratoryEditComponent.prototype.testChanged = function (event) {
        var _this = this;
        this.selectedTests.forEach(function (labTest) {
            if (!_this.labTestIds.has(labTest.id)) {
                _this.rows.push({
                    lab_test_id: labTest.id,
                    description: labTest.description,
                    unit: labTest.unit,
                    result: null
                });
                _this.rows = _this.rows.map(function (line) {
                    if ((!!line.result && line.result.toUpperCase() === 'NAN') || !line.result) {
                        line.result = null;
                    }
                    return line;
                });
                _this.rows = tslib_1.__spread(_this.rows);
                _this.labTestIds.add(labTest.id);
            }
            _this.rows = _this.rows.filter(function (row) { return _this.selectedTests.map(function (test) { return test.id; }).includes(row.lab_test_id); });
            _this.labTestIds.forEach(function (id) {
                if (!_this.rows.map(function (r) { return r.lab_test_id; }).includes(id)) {
                    _this.labTestIds.delete(id);
                }
            });
        });
    };
    LaboratoryEditComponent.prototype.updateValue = function (event, cell, rowIndex) {
        console.log('inline editing rowIndex', rowIndex);
        this.editing[rowIndex + '-' + cell] = false;
        this.rows[rowIndex][cell] = cell === 'indication' ? event : event.target.value;
        this.errors[rowIndex + '-result'] = this.entity.dateAssay && !this.rows[rowIndex][cell];
        this.errors[rowIndex + '-indication'] = this.rows[rowIndex].lab_test_id === 16 && !this.rows[rowIndex]['indication'];
        this.rows = tslib_1.__spread(this.rows);
        console.log('UPDATED!', this.rows[rowIndex][cell]);
    };
    LaboratoryEditComponent.prototype.subscribeToSaveResponse = function (result) {
        var _this = this;
        result.subscribe(function (res) { return _this.onSaveSuccess(res.body); }, function (res) {
            _this.appLoaderService.close();
            _this.onSaveError();
            _this.onError(res.message);
        });
    };
    LaboratoryEditComponent.prototype.onSaveSuccess = function (result) {
        this.appLoaderService.close();
        this.isSaving = false;
        this.notification.showInfo('Laboratory request successfully saved');
        this.previousState();
    };
    LaboratoryEditComponent.prototype.onSaveError = function () {
        this.isSaving = false;
        this.error = true;
        this.notification.showError('Error saving laboratory request');
    };
    LaboratoryEditComponent.prototype.onError = function (errorMessage) {
        this.isSaving = false;
        this.notification.showError(errorMessage);
    };
    LaboratoryEditComponent.ctorParameters = function () { return [
        { type: LaboratoryService },
        { type: NotificationService },
        { type: AppLoaderService },
        { type: TdDialogService },
        { type: ActivatedRoute }
    ]; };
    tslib_1.__decorate([
        ViewChild(MatProgressBar, { static: true }),
        tslib_1.__metadata("design:type", MatProgressBar)
    ], LaboratoryEditComponent.prototype, "progressBar", void 0);
    tslib_1.__decorate([
        ViewChild(MatButton, { static: true }),
        tslib_1.__metadata("design:type", MatButton)
    ], LaboratoryEditComponent.prototype, "submitButton", void 0);
    LaboratoryEditComponent = tslib_1.__decorate([
        Component({
            selector: 'lamis-laboratory-edit',
            template: "<div class=\"lamis-edit-form\">\n    <div class=\"lamis-edit-form-container\">\n        <form name=\"form\" role=\"form\" novalidate (ngSubmit)=\"save()\" #laboratoryForm=\"ngForm\">\n            <mat-card class=\"default\">\n                <mat-card-header>\n                </mat-card-header>\n                <mat-card-content *ngIf=\"patient\">\n                    <div>\n                        <mat-form-field class=\"full-width\" *ngIf=\"entity && dateRegistration\">\n                            <input matInput [matDatepicker]=\"picker\"\n                                   placeholder=\"Date of Sample Collection\"\n                                   [(ngModel)]=\"entity.dateSampleCollected\"\n                                   #dateCollected=\"ngModel\"\n                                   (dateChange)=\"sampleDateChanged($event.value)\"\n                                   [max]=\"today\"\n                                   [min]=\"dateRegistration\"\n                                   required\n                                   name=\"dateCollected\">\n                            <mat-datepicker-toggle\n                                    matSuffix\n                                    [for]=\"picker\">\n                            </mat-datepicker-toggle>\n                            <mat-datepicker #picker></mat-datepicker>\n                            <mat-error\n                                    *ngIf=\"dateCollected.errors && (dateCollected.dirty || dateCollected.touched) && (dateCollected.errors.required)\">\n                                Date of Sample Collection is required\n                            </mat-error>\n                            <mat-error\n                                    *ngIf=\"dateCollected.errors && (dateCollected.dirty || dateCollected.touched) && (dateCollected.errors.min)\">\n                                Date of Sample Collection cannot be\n                                before {{entity.patient.dateRegistration | date: 'dd MMM, yyyy'}}\n                            </mat-error>\n                            <mat-error\n                                    *ngIf=\"dateCollected.errors && (dateCollected.dirty || dateCollected.touched) && (dateCollected.errors.max)\">\n                                Date of Sample Collection cannot be in the future\n                            </mat-error>\n                        </mat-form-field>\n                    </div>\n                    <div>\n                        <mat-form-field class=\"full-width\">\n                            <input matInput [(ngModel)]=\"entity.labNo\"\n                                   placeholder=\"Laboratory Number\"\n                                   #labNo=\"ngModel\" required name=\"labNo\"/>\n                            <mat-error\n                                    *ngIf=\"labNo.errors && (labNo.dirty || labNo.touched) && (labNo.errors.required)\">\n                                Lab Number is required\n                            </mat-error>\n                        </mat-form-field>\n                    </div>\n                    <div *ngIf=\"minAssayDate\">\n                        <mat-form-field class=\"full-width\">\n                            <input matInput [matDatepicker]=\"picker1\"\n                                   placeholder=\"Date Assay\"\n                                   [(ngModel)]=\"entity.dateAssay\"\n                                   [matDatepickerFilter]=\"filterDates.bind(this)\"\n                                   (dateChange)=\"assayDateChanged($event.value)\"\n                                   #dateAssay=\"ngModel\"\n                                   [min]=\"minAssayDate\"\n                                   [max]=\"today\"\n                                   name=\"dateAssay\">\n                            <mat-datepicker-toggle\n                                    matSuffix\n                                    [for]=\"picker1\">\n                            </mat-datepicker-toggle>\n                            <mat-datepicker #picker1></mat-datepicker>\n                            <mat-error\n                                    *ngIf=\"dateAssay.errors && (dateAssay.dirty || dateAssay.touched) && (dateAssay.errors.required)\">\n                                Date Assay is required\n                            </mat-error>\n                            <mat-error\n                                    *ngIf=\"dateAssay.errors && (dateAssay.dirty || dateAssay.touched) && (dateAssay.errors.max)\">\n                                Date Assay must be after {{today | date: 'dd MMM, yyyy'}}\n                            </mat-error>\n                            <mat-error\n                                    *ngIf=\"dateAssay.errors && (dateAssay.dirty || dateAssay.touched) && (dateAssay.errors.min)\">\n                                Date Assay must be after {{minAssayDate}}\n                            </mat-error>\n                        </mat-form-field>\n                    </div>\n                    <div *ngIf=\"minReportedDate\">\n                        <mat-form-field class=\"full-width\">\n                            <input matInput [matDatepicker]=\"picker2\"\n                                   placeholder=\"Date Result Received\"\n                                   [(ngModel)]=\"entity.dateResultReceived\"\n                                   [matDatepickerFilter]=\"filterDates.bind(this)\"\n                                   #dateReported=\"ngModel\"\n                                   [min]=\"minReportedDate\"\n                                   [max]=\"today\"\n                                   [required]=\"!!entity.dateAssay\"\n                                   name=\"dateReported\">\n                            <mat-datepicker-toggle\n                                    matSuffix\n                                    [for]=\"picker2\">\n                            </mat-datepicker-toggle>\n                            <mat-datepicker #picker2></mat-datepicker>\n                            <mat-error\n                                    *ngIf=\"dateReported.errors && (dateReported.dirty || dateReported.touched) && (dateReported.errors.required)\">\n                                Date Result Received is required\n                            </mat-error>\n                            <mat-error\n                                    *ngIf=\"dateReported.errors && (dateReported.dirty || dateReported.touched) && (dateReported.errors.max)\">\n                                Date Result Received must be after {{today | date: 'dd MMM, yyyy'}}\n                            </mat-error>\n                            <mat-error\n                                    *ngIf=\"dateReported.errors && (dateReported.dirty || dateReported.touched) && (dateReported.errors.min)\">\n                                Date Result Received must not be before {{minReportedDate | date : 'dd MMM, yyyy'}}\n                            </mat-error>\n                        </mat-form-field>\n                    </div>\n                    <div class=\"row\">\n                        <div class=\"col-md-6\">\n                            <mat-form-field>\n                                <mat-select placeholder=\"Laboratory Test Category\"\n                                            (selectionChange)=\"categoryChanged($event.value)\">\n                                    <mat-option></mat-option>\n                                    <mat-option *ngFor=\"let category of categories\"\n                                                [value]=\"category\">{{category.category}}</mat-option>\n                                </mat-select>\n                            </mat-form-field>\n                        </div>\n                        <div class=\"col-md-6\">\n                            <mat-form-field>\n                                <mat-select placeholder=\"Laboratory Test\"\n                                            multiple\n                                            name=\"regimen\"\n                                            [(ngModel)]=\"selectedTests\"\n                                            [compareWith]=\"entityCompare\"\n                                            (selectionChange)=\"testChanged($event.value)\">\n                                    <mat-option *ngFor=\"let test of tests\"\n                                                [value]=\"test\">{{test.description}}</mat-option>\n                                </mat-select>\n                            </mat-form-field>\n                        </div>\n                    </div>\n                    <div class=\"row\">\n                        Selected Test\n                        <mat-divider></mat-divider>\n                        <ngx-datatable\n                            #mydatatable\n                            class=\"material full-width\"\n                            [headerHeight]=\"50\"\n                            [limit]=\"5\"\n                            [columnMode]=\"ColumnMode.force\"\n                            [footerHeight]=\"50\"\n                            rowHeight=\"auto\"\n                            [rows]=\"rows\"\n                        >\n                            <ngx-datatable-column name=\"Test Description\" [prop]=\"'description'\"\n                                                  [canAutoResize]=\"true\">\n                                <ng-template ngx-datatable-cell-template let-value=\"value\">\n                                    <mat-form-field class=\"full-width\">\n                                        <input matInput disabled [value]=\"value\" style=\"font-weight: 900\">\n                                    </mat-form-field>\n                                </ng-template>\n                            </ngx-datatable-column>\n                            <ngx-datatable-column name=\"Result\" [prop]=\"'result'\" [canAutoResize]=\"true\">\n                                <ng-template ngx-datatable-cell-template let-rowIndex=\"rowIndex\" let-value=\"value\"\n                                             let-row=\"row\">\n                                    <!--<mat-form-field *ngIf=\"!editing[rowIndex + '']\" class=\"full-width\">\n                                        <input matInput [value]=\"value\" disabled>\n                                    </mat-form-field>\n                                    <mat-form-field *ngIf=\"editing[rowIndex + '']\">-->\n                                    <mat-form-field class=\"full-width\">\n                                        <input\n                                                autofocus\n                                                matInput\n                                                type=\"text\"\n                                                name=\"result\"\n                                                [required]=\"!!entity.dateAssay\"\n                                                (blur)=\"updateValue($event, 'result', rowIndex)\"\n                                                [value]=\"value || ''\"\n                                        >\n                                        <span matSuffix>&nbsp;{{row.unit}}</span>\n                                        <mat-error *ngIf=\"errors[rowIndex + '-result']\">\n                                            Result value is required\n                                        </mat-error>\n                                    </mat-form-field>\n                                </ng-template>\n                            </ngx-datatable-column>\n                            <ngx-datatable-column [maxWidth]=\"1\">\n                                <ng-template ngx-datatable-cell-template let-rowIndex=\"rowIndex\" let-value=\"value\"\n                                             let-row=\"row\">\n                                </ng-template>\n                            </ngx-datatable-column>\n                            <ngx-datatable-column name=\"Comment\" [prop]=\"'comment'\" [canAutoResize]=\"true\">\n                                <ng-template ngx-datatable-cell-template let-rowIndex=\"rowIndex\" let-value=\"value\"\n                                             let-row=\"row\">\n                                    <!--<mat-form-field *ngIf=\"!editing[rowIndex + '']\" class=\"full-width\">\n                                        <textarea matInput [value]=\"value\" disabled rows=\"2\"></textarea>\n                                    </mat-form-field>\n                                    <mat-form-field *ngIf=\"editing[rowIndex + '']\">-->\n                                    <mat-form-field class=\"full-width\">\n                                        <textarea\n                                                autofocus\n                                                matInput\n                                                rows=\"2\"\n                                                (blur)=\"updateValue($event, 'comment', rowIndex)\"\n                                                [value]=\"value\"\n                                        ></textarea>\n                                    </mat-form-field>\n                                </ng-template>\n                            </ngx-datatable-column>\n                            <ngx-datatable-column name=\"Indication\" [canAutoResize]=\"true\">\n                                <ng-template ngx-datatable-cell-template let-rowIndex=\"rowIndex\" let-value=\"value\"\n                                             let-row=\"row\">\n                                    <!--<mat-form-field *ngIf=\"!editing[rowIndex + '']\" class=\"full-width\">\n                                        <input matInput [value]=\"value\" disabled>\n                                    </mat-form-field>\n                                    <mat-form-field *ngIf=\"editing[rowIndex + '']\">-->\n                                    <mat-form-field class=\"full-width\">\n                                        <mat-select autofocus\n                                                    [value]=\"value\"\n                                                    [required]=\"row.lab_test_id === 16\"\n                                                    name=\"ind\"\n                                                    (valueChange)=\"updateValue($event, 'indication', rowIndex)\">\n                                            <mat-option></mat-option>\n                                            <mat-option [value]=\"'Routine Monitoring'\">Routine Monitoring</mat-option>\n                                            <mat-option [value]=\"'Targeted Monitoring'\">Targeted Monitoring</mat-option>\n                                        </mat-select>\n                                        <mat-error *ngIf=\"errors[rowIndex + '-indication']\">\n                                            Viral Load indication is required\n                                        </mat-error>\n                                    </mat-form-field>\n                                </ng-template>\n                            </ngx-datatable-column>\n                            <!--<ngx-datatable-column name=\"Action\" prop=\"id\" [canAutoResize]=\"true\">\n                                <ng-template ngx-datatable-cell-template let-rowIndex=\"rowIndex\" let-value=\"value\"\n                                             let-row=\"row\">\n                                    <button type=\"button\" mat-icon-button\n                                            *ngIf=\"!editing[rowIndex + '']\"\n                                            (click)=\"edit(rowIndex)\"\n                                            (mouseenter)=\"edit(rowIndex)\"\n                                            title=\"Click to edit\">\n                                        <mat-icon>edit</mat-icon>\n                                    </button>\n                                    <button type=\"button\" mat-icon-button\n                                            *ngIf=\"editing[rowIndex + '']\"\n                                            (dblclick)=\"editing[rowIndex + ''] = false\"\n                                            title=\"Click to save\">\n                                        <mat-icon>save</mat-icon>\n                                    </button>\n                                </ng-template>\n                            </ngx-datatable-column>-->\n                        </ngx-datatable>\n                    </div>\n                    <mat-divider></mat-divider>\n                </mat-card-content>\n                <mat-card-actions class=\"lamis-edit-form-actions\">\n                    <button mat-raised-button type=\"button\" (click)=\"previousState()\">Back</button>\n                    <button mat-raised-button color='primary'\n                            [disabled]=\"laboratoryForm.invalid || rows.length === 0 || isSaving\"\n                            type=\"submit\">\n                        {{entity.id !== undefined ? 'Update' : 'Save'}}\n                    </button>\n                </mat-card-actions>\n            </mat-card>\n        </form>\n    </div>\n</div>\n"
        }),
        tslib_1.__metadata("design:paramtypes", [LaboratoryService,
            NotificationService,
            AppLoaderService,
            TdDialogService,
            ActivatedRoute])
    ], LaboratoryEditComponent);
    return LaboratoryEditComponent;
}());
export { LaboratoryEditComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGFib3JhdG9yeS1lZGl0LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL2xhbWlzLWxhYm9yYXRvcnktMS40LjAvIiwic291cmNlcyI6WyJsaWIvY29tcG9uZW50cy9sYWJvcmF0b3J5LWVkaXQuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFVLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUU3RCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQztBQUNuRSxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUN6RCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDakQsT0FBTyxFQUFFLFNBQVMsRUFBRSxjQUFjLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUc5RCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFDckQsT0FBTyxLQUFLLE9BQU8sTUFBTSxRQUFRLENBQUM7QUFFbEMsT0FBTyxFQUFFLGdCQUFnQixFQUFFLGFBQWEsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ2xFLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUVqRCxJQUFNLE1BQU0sR0FBRyxPQUFPLENBQUM7QUFNdkI7SUF1QkksaUNBQW9CLGlCQUFvQyxFQUNsQyxZQUFpQyxFQUNuQyxnQkFBa0MsRUFDbEMsY0FBK0IsRUFDN0IsY0FBOEI7UUFKaEMsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUFtQjtRQUNsQyxpQkFBWSxHQUFaLFlBQVksQ0FBcUI7UUFDbkMscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUNsQyxtQkFBYyxHQUFkLGNBQWMsQ0FBaUI7UUFDN0IsbUJBQWMsR0FBZCxjQUFjLENBQWdCO1FBeEJwRCxXQUFNLEdBQWUsRUFBRSxDQUFDO1FBS3hCLGlCQUFZLEdBQUcsTUFBTSxFQUFFLENB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QUErQztTQUNsRCxDQUFDO2lEQXdCeUMsaUJBQWlCO1lBQ3BCLG1CQUFtQjtZQUNqQixnQkFBZ0I7WUFDbEIsZUFBZTtZQUNiLGNBQWM7T0EzQjNDLHVCQUF1QixDQXdSbkM7SUFBRCw4QkFBQztDQUFBLEFBeFJELElBd1JDO1NBeFJZLHVCQUF1QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgT25Jbml0LCBWaWV3Q2hpbGQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IExhYm9yYXRvcnksIExhYm9yYXRvcnlMaW5lLCBMYWJUZXN0LCBMYWJUZXN0Q2F0ZWdvcnksIFBhdGllbnQgfSBmcm9tICcuLi9tb2RlbC9sYWJvcmF0b3J5Lm1vZGVsJztcbmltcG9ydCB7IExhYm9yYXRvcnlTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvbGFib3JhdG9yeS5zZXJ2aWNlJztcbmltcG9ydCB7IE5vdGlmaWNhdGlvblNlcnZpY2UgfSBmcm9tICdAYWxmcmVzY28vYWRmLWNvcmUnO1xuaW1wb3J0IHsgQWN0aXZhdGVkUm91dGUgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHsgTWF0QnV0dG9uLCBNYXRQcm9ncmVzc0JhciB9IGZyb20gJ0Bhbmd1bGFyL21hdGVyaWFsJztcbmltcG9ydCB7IEh0dHBFcnJvclJlc3BvbnNlLCBIdHRwUmVzcG9uc2UgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBDb2x1bW5Nb2RlIH0gZnJvbSAnQHN3aW1sYW5lL25neC1kYXRhdGFibGUnO1xuaW1wb3J0ICogYXMgbW9tZW50XyBmcm9tICdtb21lbnQnO1xuaW1wb3J0IHsgTW9tZW50IH0gZnJvbSAnbW9tZW50JztcbmltcG9ydCB7IEFwcExvYWRlclNlcnZpY2UsIGVudGl0eUNvbXBhcmUgfSBmcm9tICdAbGFtaXMvd2ViLWNvcmUnO1xuaW1wb3J0IHsgVGREaWFsb2dTZXJ2aWNlIH0gZnJvbSAnQGNvdmFsZW50L2NvcmUnO1xuXG5jb25zdCBtb21lbnQgPSBtb21lbnRfO1xuXG5AQ29tcG9uZW50KHtcbiAgICBzZWxlY3RvcjogJ2xhbWlzLWxhYm9yYXRvcnktZWRpdCcsXG4gICAgdGVtcGxhdGVVcmw6ICcuL2xhYm9yYXRvcnktZWRpdC5jb21wb25lbnQuaHRtbCdcbn0pXG5leHBvcnQgY2xhc3MgTGFib3JhdG9yeUVkaXRDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQge1xuICAgIEBWaWV3Q2hpbGQoTWF0UHJvZ3Jlc3NCYXIsIHtzdGF0aWM6IHRydWV9KSBwcm9ncmVzc0JhcjogTWF0UHJvZ3Jlc3NCYXI7XG4gICAgQFZpZXdDaGlsZChNYXRCdXR0b24sIHtzdGF0aWM6IHRydWV9KSBzdWJtaXRCdXR0b246IE1hdEJ1dHRvbjtcbiAgICBlbnRpdHk6IExhYm9yYXRvcnkgPSB7fTtcbiAgICBwYXRpZW50OiBQYXRpZW50O1xuICAgIGRhdGVSZWdpc3RyYXRpb246IE1vbWVudDtcbiAgICBtaW5Bc3NheURhdGU6IE1vbWVudDtcbiAgICBtaW5SZXBvcnRlZERhdGU6IE1vbWVudDtcbiAgICBtYXhOZXh0VmlzaXQgPSBtb21lbnQoKS5hZGQoMjAwLCAnZGF5cycpO1xuICAgIGNhdGVnb3JpZXM6IExhYlRlc3RDYXRlZ29yeVtdID0gW107XG4gICAgdGVzdHM6IExhYlRlc3RbXSA9IFtdO1xuICAgIHNlbGVjdGVkVGVzdHM6IExhYlRlc3RbXSA9IFtdO1xuICAgIGlzU2F2aW5nOiBib29sZWFuO1xuICAgIGVycm9yID0gZmFsc2U7XG4gICAgdG9tb3Jyb3cgPSBtb21lbnQoKS5hZGQoMSwgJ2RheXMnKTtcbiAgICB0b2RheSA9IG1vbWVudCgpO1xuICAgIENvbHVtbk1vZGUgPSBDb2x1bW5Nb2RlO1xuICAgIGVkaXRpbmcgPSB7fTtcbiAgICBlcnJvcnMgPSB7fTtcbiAgICByb3dzOiBMYWJvcmF0b3J5TGluZVtdID0gW107XG4gICAgbGFiVGVzdElkcyA9IG5ldyBTZXQoKTtcbiAgICB2aXNpdERhdGVzOiBNb21lbnRbXSA9IFtdO1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBsYWJvcmF0b3J5U2VydmljZTogTGFib3JhdG9yeVNlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJvdGVjdGVkIG5vdGlmaWNhdGlvbjogTm90aWZpY2F0aW9uU2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIGFwcExvYWRlclNlcnZpY2U6IEFwcExvYWRlclNlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBfZGlhbG9nU2VydmljZTogVGREaWFsb2dTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByb3RlY3RlZCBhY3RpdmF0ZWRSb3V0ZTogQWN0aXZhdGVkUm91dGUpIHtcbiAgICB9XG5cbiAgICBjcmVhdGVFbnRpdHkoKTogTGFib3JhdG9yeSB7XG4gICAgICAgIHJldHVybiA8TGFib3JhdG9yeT57fTtcbiAgICB9XG5cbiAgICBuZ09uSW5pdCgpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5pc1NhdmluZyA9IGZhbHNlO1xuICAgICAgICB0aGlzLmFjdGl2YXRlZFJvdXRlLmRhdGEuc3Vic2NyaWJlKCh7ZW50aXR5fSkgPT4ge1xuICAgICAgICAgICAgdGhpcy5lbnRpdHkgPSAhIWVudGl0eSAmJiBlbnRpdHkuYm9keSA/IGVudGl0eS5ib2R5IDogZW50aXR5O1xuICAgICAgICAgICAgaWYgKHRoaXMuZW50aXR5ID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmVudGl0eSA9IHRoaXMuY3JlYXRlRW50aXR5KCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCBwYXRpZW50SWQgPSB0aGlzLmFjdGl2YXRlZFJvdXRlLnNuYXBzaG90LnBhcmFtTWFwLmdldCgncGF0aWVudElkJyk7XG4gICAgICAgICAgICB0aGlzLmxhYm9yYXRvcnlTZXJ2aWNlLmdldFBhdGllbnQocGF0aWVudElkKS5zdWJzY3JpYmUoKHJlcykgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuZW50aXR5LnBhdGllbnQgPSByZXM7XG4gICAgICAgICAgICAgICAgdGhpcy5wYXRpZW50ID0gcmVzO1xuICAgICAgICAgICAgICAgIHRoaXMuZGF0ZVJlZ2lzdHJhdGlvbiA9IHJlcy5kYXRlUmVnaXN0cmF0aW9uO1xuICAgICAgICAgICAgICAgIHRoaXMuZW50aXR5LmZhY2lsaXR5ID0gcmVzLmZhY2lsaXR5O1xuICAgICAgICAgICAgICAgIHRoaXMubGFib3JhdG9yeVNlcnZpY2UuZ2V0VmlzaXREYXRlc0J5UGF0aWVudChyZXMuaWQpLnN1YnNjcmliZSgocmVzMSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnZpc2l0RGF0ZXMgPSByZXMxO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIHRoaXMubWluUmVwb3J0ZWREYXRlID0gdGhpcy5lbnRpdHkucGF0aWVudC5kYXRlUmVnaXN0cmF0aW9uLmNsb25lKCkuYWRkKDAsICdkYXlzJyk7XG4gICAgICAgICAgICAgICAgdGhpcy5taW5Bc3NheURhdGUgPSB0aGlzLmVudGl0eS5wYXRpZW50LmRhdGVSZWdpc3RyYXRpb24uY2xvbmUoKS5hZGQoMCwgJ2RheXMnKTtcblxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmVudGl0eS5pZCkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZU1pbkRhdGVzKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGlmICh0aGlzLmVudGl0eS5pZCkge1xuICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlTWluRGF0ZXMoKTtcblxuICAgICAgICAgICAgICAgIHRoaXMucm93cyA9IFsuLi50aGlzLmVudGl0eS5saW5lcy5tYXAociA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubGFib3JhdG9yeVNlcnZpY2UuZ2V0TGFiVGVzdEJ5SWQoci5sYWJfdGVzdF9pZCkuc3Vic2NyaWJlKHJlcyA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICByLmRlc2NyaXB0aW9uID0gcmVzLmRlc2NyaXB0aW9uO1xuICAgICAgICAgICAgICAgICAgICAgICAgci51bml0ID0gcmVzLnVuaXQ7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMudGVzdHMubWFwKHIxID0+IHIxLmlkKS5pbmNsdWRlcyhyLmxhYl90ZXN0X2lkKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudGVzdHMucHVzaChyZXMpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRUZXN0cy5wdXNoKHJlcyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50ZXN0cyA9IFsuLi50aGlzLnRlc3RzXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdGVkVGVzdHMgPSBbLi4udGhpcy5zZWxlY3RlZFRlc3RzXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHIucmVzdWx0ID0gci5yZXN1bHQgfHwgJyc7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gcjtcbiAgICAgICAgICAgICAgICB9KV07XG5cbiAgICAgICAgICAgICAgICB0aGlzLnJvd3MgPSBbLi4udGhpcy5yb3dzXTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy5sYWJvcmF0b3J5U2VydmljZS5sYWJvcmF0b3J5Q2F0ZWdvcmllcygpLnN1YnNjcmliZShyZXMgPT4gdGhpcy5jYXRlZ29yaWVzID0gcmVzKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgdXBkYXRlTWluRGF0ZXMoKSB7XG4gICAgICAgIHRoaXMubWluQXNzYXlEYXRlID0gdGhpcy5lbnRpdHkuZGF0ZVNhbXBsZUNvbGxlY3RlZC5jbG9uZSgpLmFkZCgwLCAnZGF5cycpO1xuICAgICAgICBpZiAodGhpcy5lbnRpdHkuZGF0ZUFzc2F5KSB7XG4gICAgICAgICAgICB0aGlzLm1pblJlcG9ydGVkRGF0ZSA9IHRoaXMuZW50aXR5LmRhdGVBc3NheS5jbG9uZSgpLmFkZCgwLCAnZGF5cycpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5taW5SZXBvcnRlZERhdGUgPSB0aGlzLmVudGl0eS5kYXRlU2FtcGxlQ29sbGVjdGVkLmNsb25lKCkuYWRkKDEsICdkYXlzJyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBmaWx0ZXJEYXRlcyhkYXRlOiBNb21lbnQpOiBib29sZWFuIHtcbiAgICAgICAgbGV0IGV4aXN0cyA9IGZhbHNlO1xuICAgICAgICB0aGlzLnZpc2l0RGF0ZXMuZm9yRWFjaChkID0+IHtcbiAgICAgICAgICAgIGlmIChkYXRlLmRpZmYoZCwgJ2RheXMnKSA9PT0gMCkge1xuICAgICAgICAgICAgICAgIGV4aXN0cyA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gKHRoaXMuZW50aXR5LmlkICYmIGRhdGUuZGlmZih0aGlzLmVudGl0eS5kYXRlU2FtcGxlQ29sbGVjdGVkLCAnZGF5cycpID09PSAwKSB8fCAhZXhpc3RzO1xuICAgIH1cblxuICAgIHByZXZpb3VzU3RhdGUoKSB7XG4gICAgICAgIHdpbmRvdy5oaXN0b3J5LmJhY2soKTtcbiAgICB9XG5cbiAgICBlbnRpdHlDb21wYXJlKGUxLCBlMikge1xuICAgICAgICByZXR1cm4gZW50aXR5Q29tcGFyZShlMSwgZTIpO1xuICAgIH1cblxuICAgIHNhbXBsZURhdGVDaGFuZ2VkKGRhdGU6IE1vbWVudCkge1xuICAgICAgICB0aGlzLm1pbkFzc2F5RGF0ZSA9IGRhdGUuY2xvbmUoKS5hZGQoMCwgJ2RheXMnKTtcbiAgICB9XG5cbiAgICBhc3NheURhdGVDaGFuZ2VkKGRhdGU6IE1vbWVudCkge1xuICAgICAgICB0aGlzLm1pblJlcG9ydGVkRGF0ZSA9IGRhdGUuY2xvbmUoKS5hZGQoMCwgJ2RheXMnKTtcbiAgICB9XG5cbiAgICBlZGl0KHJvd0luZGV4KSB7XG4gICAgICAgIHRoaXMuZWRpdGluZ1tyb3dJbmRleCArICcnXSA9IHRydWU7XG4gICAgfVxuXG4gICAgc2F2ZSgpIHtcbiAgICAgICAgdGhpcy5pc1NhdmluZyA9IHRydWU7XG4gICAgICAgIGxldCBhYm9ydCA9IGZhbHNlO1xuICAgICAgICAvLyB0aGlzLnByb2dyZXNzQmFyLm1vZGUgPSAnaW5kZXRlcm1pbmF0ZSc7XG4gICAgICAgIHRoaXMucm93cyA9IHRoaXMucm93cy5tYXAobGluZSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGxpbmUubGFiX3Rlc3RfaWQgPT09IDE2ICYmICFsaW5lLmluZGljYXRpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fZGlhbG9nU2VydmljZS5vcGVuQWxlcnQoe1xuICAgICAgICAgICAgICAgICAgICAgICAgdGl0bGU6ICdJbmRpY2F0aW9uIGlzIHJlcXVpcmVkJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6ICdQbGVhc2Ugc2VsZWN0IGluZGljYXRpb24gZm9yIFZpcmFsIExvYWQgVGVzdCcsXG4gICAgICAgICAgICAgICAgICAgICAgICBkaXNhYmxlQ2xvc2U6IHRydWVcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaXNTYXZpbmcgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgYWJvcnQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAobGluZS5sYWJfdGVzdF9pZCAhPT0gMTYgJiYgbGluZS5pbmRpY2F0aW9uKSB7XG4gICAgICAgICAgICAgICAgICAgIGxpbmUuaW5kaWNhdGlvbiA9IG51bGw7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmVudGl0eS5kYXRlQXNzYXkgJiYgIWxpbmUucmVzdWx0KSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2RpYWxvZ1NlcnZpY2Uub3BlbkFsZXJ0KHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRpdGxlOiAnUmVzdWx0IGlzIHJlcXVpcmVkJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6ICdQbGVhc2UgcHJvdmlkZSB0ZXN0IHJlc3VsdCcsXG4gICAgICAgICAgICAgICAgICAgICAgICBkaXNhYmxlQ2xvc2U6IHRydWVcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaXNTYXZpbmcgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgYWJvcnQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAobGluZS5yZXN1bHQgJiYgIXRoaXMuZW50aXR5LmRhdGVBc3NheSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmlzU2F2aW5nID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIGFib3J0ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fZGlhbG9nU2VydmljZS5vcGVuQWxlcnQoe1xuICAgICAgICAgICAgICAgICAgICAgICAgdGl0bGU6ICdGb3JtIG5vdCBjb21wbGV0ZScsXG4gICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiAnUGxlYXNlIHByb3ZpZGUgRGF0ZSBvZiBUZXN0IEFzc2F5JyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGRpc2FibGVDbG9zZTogdHJ1ZVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gcGFyc2VJbnQobGluZS5yZXN1bHQsIDEwKTtcbiAgICAgICAgICAgICAgICBpZiAoKGxpbmUubGFiX3Rlc3RfaWQgPT09IDE2IHx8IGxpbmUubGFiX3Rlc3RfaWQgPT09IDEpICYmIHRoaXMuZW50aXR5LmRhdGVBc3NheSkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXJlc3VsdCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHplcm8gPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHQgPT09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB6ZXJvID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghemVybykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2RpYWxvZ1NlcnZpY2Uub3BlbkFsZXJ0KHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGl0bGU6ICdSZXN1bHQgaXMgaW52YWxpZCcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6ICdQbGVhc2UgcHJvdmlkZSBudW1lcmljIHJlc3VsdCBmb3IgdGVzdCcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc2FibGVDbG9zZTogdHJ1ZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaXNTYXZpbmcgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhYm9ydCA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocmVzdWx0IDwgMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fZGlhbG9nU2VydmljZS5vcGVuQWxlcnQoe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpdGxlOiAnUmVzdWx0IGlzIGludmFsaWQnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6ICdQbGVhc2UgcHJvdmlkZSB2YWx1ZSA+PTAgZm9yIHRlc3QgcmVzdWx0JyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNhYmxlQ2xvc2U6IHRydWVcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pc1NhdmluZyA9IGZhbHNlO1xuICAgICAgICAgICAgICAgICAgICAgICAgYWJvcnQgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgbGluZS5yZXN1bHQgPSByZXN1bHQudG9TdHJpbmcoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoISFsaW5lLnJlc3VsdCAmJiBsaW5lLnJlc3VsdC50b1VwcGVyQ2FzZSgpID09PSAnTkFOJykge1xuICAgICAgICAgICAgICAgICAgICBsaW5lLnJlc3VsdCA9IG51bGw7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBsaW5lO1xuICAgICAgICAgICAgfVxuICAgICAgICApO1xuXG4gICAgICAgIGlmIChhYm9ydCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuYXBwTG9hZGVyU2VydmljZS5vcGVuKCdTYXZpbmcgcmVxdWVzdC4uLicpO1xuICAgICAgICB0aGlzLmVudGl0eS5saW5lcyA9IHRoaXMucm93cztcblxuICAgICAgICBpZiAodGhpcy5lbnRpdHkuaWQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgdGhpcy5zdWJzY3JpYmVUb1NhdmVSZXNwb25zZSh0aGlzLmxhYm9yYXRvcnlTZXJ2aWNlLnVwZGF0ZSh0aGlzLmVudGl0eSkpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5zdWJzY3JpYmVUb1NhdmVSZXNwb25zZSh0aGlzLmxhYm9yYXRvcnlTZXJ2aWNlLmNyZWF0ZSh0aGlzLmVudGl0eSkpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgY2F0ZWdvcnlDaGFuZ2VkKHR5cGU6IGFueSkge1xuICAgICAgICB0aGlzLmxhYm9yYXRvcnlTZXJ2aWNlLmxhYlRlc3RzQnlDYXRlZ29yeSh0eXBlLmlkKS5zdWJzY3JpYmUoKHJlczogTGFiVGVzdFtdKSA9PiB7XG4gICAgICAgICAgICByZXMuZm9yRWFjaCgobGFiVGVzdDogTGFiVGVzdCkgPT4ge1xuICAgICAgICAgICAgICAgIGlmICghdGhpcy50ZXN0cy5tYXAociA9PiByLmlkKS5pbmNsdWRlcyhsYWJUZXN0LmlkKSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnRlc3RzLnB1c2gobGFiVGVzdCk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMudGVzdHMgPSBbLi4udGhpcy50ZXN0c107XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHRlc3RDaGFuZ2VkKGV2ZW50KSB7XG4gICAgICAgIHRoaXMuc2VsZWN0ZWRUZXN0cy5mb3JFYWNoKGxhYlRlc3QgPT4ge1xuICAgICAgICAgICAgaWYgKCF0aGlzLmxhYlRlc3RJZHMuaGFzKGxhYlRlc3QuaWQpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5yb3dzLnB1c2goe1xuICAgICAgICAgICAgICAgICAgICBsYWJfdGVzdF9pZDogbGFiVGVzdC5pZCxcbiAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246IGxhYlRlc3QuZGVzY3JpcHRpb24sXG4gICAgICAgICAgICAgICAgICAgIHVuaXQ6IGxhYlRlc3QudW5pdCxcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0OiBudWxsXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgdGhpcy5yb3dzID0gdGhpcy5yb3dzLm1hcChsaW5lID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCghIWxpbmUucmVzdWx0ICYmIGxpbmUucmVzdWx0LnRvVXBwZXJDYXNlKCkgPT09ICdOQU4nKSB8fCAhbGluZS5yZXN1bHQpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmUucmVzdWx0ID0gbnVsbDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbGluZTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB0aGlzLnJvd3MgPSBbLi4udGhpcy5yb3dzXTtcbiAgICAgICAgICAgICAgICB0aGlzLmxhYlRlc3RJZHMuYWRkKGxhYlRlc3QuaWQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5yb3dzID0gdGhpcy5yb3dzLmZpbHRlcihyb3cgPT4gdGhpcy5zZWxlY3RlZFRlc3RzLm1hcCh0ZXN0ID0+IHRlc3QuaWQpLmluY2x1ZGVzKHJvdy5sYWJfdGVzdF9pZCkpO1xuICAgICAgICAgICAgdGhpcy5sYWJUZXN0SWRzLmZvckVhY2goaWQgPT4ge1xuICAgICAgICAgICAgICAgIGlmICghdGhpcy5yb3dzLm1hcChyID0+IHIubGFiX3Rlc3RfaWQpLmluY2x1ZGVzKGlkKSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmxhYlRlc3RJZHMuZGVsZXRlKGlkKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgdXBkYXRlVmFsdWUoZXZlbnQsIGNlbGwsIHJvd0luZGV4KSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCdpbmxpbmUgZWRpdGluZyByb3dJbmRleCcsIHJvd0luZGV4KTtcbiAgICAgICAgdGhpcy5lZGl0aW5nW3Jvd0luZGV4ICsgJy0nICsgY2VsbF0gPSBmYWxzZTtcbiAgICAgICAgdGhpcy5yb3dzW3Jvd0luZGV4XVtjZWxsXSA9IGNlbGwgPT09ICdpbmRpY2F0aW9uJyA/IGV2ZW50IDogZXZlbnQudGFyZ2V0LnZhbHVlO1xuICAgICAgICB0aGlzLmVycm9yc1tyb3dJbmRleCArICctcmVzdWx0J10gPSB0aGlzLmVudGl0eS5kYXRlQXNzYXkgJiYgIXRoaXMucm93c1tyb3dJbmRleF1bY2VsbF07XG4gICAgICAgIHRoaXMuZXJyb3JzW3Jvd0luZGV4ICsgJy1pbmRpY2F0aW9uJ10gPSB0aGlzLnJvd3Nbcm93SW5kZXhdLmxhYl90ZXN0X2lkID09PSAxNiAmJiAhdGhpcy5yb3dzW3Jvd0luZGV4XVsnaW5kaWNhdGlvbiddO1xuICAgICAgICB0aGlzLnJvd3MgPSBbLi4udGhpcy5yb3dzXTtcbiAgICAgICAgY29uc29sZS5sb2coJ1VQREFURUQhJywgdGhpcy5yb3dzW3Jvd0luZGV4XVtjZWxsXSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdWJzY3JpYmVUb1NhdmVSZXNwb25zZShyZXN1bHQ6IE9ic2VydmFibGU8SHR0cFJlc3BvbnNlPGFueT4+KSB7XG4gICAgICAgIHJlc3VsdC5zdWJzY3JpYmUoXG4gICAgICAgICAgICAocmVzOiBIdHRwUmVzcG9uc2U8YW55PikgPT4gdGhpcy5vblNhdmVTdWNjZXNzKHJlcy5ib2R5KSxcbiAgICAgICAgICAgIChyZXM6IEh0dHBFcnJvclJlc3BvbnNlKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5hcHBMb2FkZXJTZXJ2aWNlLmNsb3NlKCk7XG4gICAgICAgICAgICAgICAgdGhpcy5vblNhdmVFcnJvcigpO1xuICAgICAgICAgICAgICAgIHRoaXMub25FcnJvcihyZXMubWVzc2FnZSk7XG4gICAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIG9uU2F2ZVN1Y2Nlc3MocmVzdWx0OiBhbnkpIHtcbiAgICAgICAgdGhpcy5hcHBMb2FkZXJTZXJ2aWNlLmNsb3NlKCk7XG4gICAgICAgIHRoaXMuaXNTYXZpbmcgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5ub3RpZmljYXRpb24uc2hvd0luZm8oJ0xhYm9yYXRvcnkgcmVxdWVzdCBzdWNjZXNzZnVsbHkgc2F2ZWQnKTtcbiAgICAgICAgdGhpcy5wcmV2aW91c1N0YXRlKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvblNhdmVFcnJvcigpIHtcbiAgICAgICAgdGhpcy5pc1NhdmluZyA9IGZhbHNlO1xuICAgICAgICB0aGlzLmVycm9yID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5ub3RpZmljYXRpb24uc2hvd0Vycm9yKCdFcnJvciBzYXZpbmcgbGFib3JhdG9yeSByZXF1ZXN0Jyk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIG9uRXJyb3IoZXJyb3JNZXNzYWdlOiBzdHJpbmcpIHtcbiAgICAgICAgdGhpcy5pc1NhdmluZyA9IGZhbHNlO1xuICAgICAgICB0aGlzLm5vdGlmaWNhdGlvbi5zaG93RXJyb3IoZXJyb3JNZXNzYWdlKTtcbiAgICB9XG59XG4iXX0=