import * as tslib_1 from "tslib";
import { Component } from '@angular/core';
import * as moment_ from 'moment';
import { ClinicService } from '../../services/clinic.service';
import { NotificationService } from '@alfresco/adf-core';
import { ActivatedRoute } from '@angular/router';
import { AppLoaderService, DATE_FORMAT } from '@lamis/web-core';
import { CervicalCancerScreeningService } from '../../services/cervical-cancer-screening.service';
var moment = moment_;
var CervicalCancerScreeningComponent = /** @class */ (function () {
    function CervicalCancerScreeningComponent(clinicService, screeningService, notification, activatedRoute, appLoaderService) {
        this.clinicService = clinicService;
        this.screeningService = screeningService;
        this.notification = notification;
        this.activatedRoute = activatedRoute;
        this.appLoaderService = appLoaderService;
        this.entity = {};
        this.observation = {};
        this.today = moment();
        this.isSaving = false;
    }
    CervicalCancerScreeningComponent.prototype.ngOnInit = function () {
        var _this = this;
        this.activatedRoute.data.subscribe(function (_a) {
            var entity = _a.entity;
            _this.observation = !!entity && entity.body ? entity.body : entity;
            if (!!_this.observation) {
                _this.entity = _this.observation.data;
            }
            else {
                _this.observation = {};
            }
            if (_this.entity === undefined) {
                _this.entity = {};
            }
            var patientId = _this.activatedRoute.snapshot.paramMap.get('patientId');
            _this.clinicService.getPatient(patientId).subscribe(function (res) {
                _this.patient = res;
                if (!!_this.entity) {
                    _this.screeningService.getScreeningByPatient(res.id).subscribe(function (r) {
                        _this.entity = r.body && r.body.data;
                        _this.observation = r.body;
                    });
                }
            });
        });
    };
    CervicalCancerScreeningComponent.prototype.previousState = function () {
        window.history.back();
    };
    CervicalCancerScreeningComponent.prototype.save = function () {
        //this.submitButton.disabled = true;
        //this.progressBar.mode = 'indeterminate';
        this.isSaving = true;
        this.appLoaderService.open('Saving cancer screening..');
        var data = {
            id: this.observation && this.observation.id || null,
            patient: this.patient,
            date: this.entity.dateScreened.format(DATE_FORMAT),
            facility: this.patient.facility,
            type: 'CERVICAL_CANCER_SCREENING',
            data: {
                cervicalCancerScreening: Object.assign({}, this.entity, {
                    dateScreened: this.entity.dateScreened != null && this.entity.dateScreened.isValid() ?
                        this.entity.dateScreened.format(DATE_FORMAT) : null,
                    dateTreated: this.entity.dateTreated != null && this.entity.dateTreated.isValid() ?
                        this.entity.dateTreated.format(DATE_FORMAT) : null,
                })
            }
        };
        if (!!this.observation.id) {
            this.subscribeToSaveResponse(this.screeningService.update(data));
        }
        else {
            this.subscribeToSaveResponse(this.screeningService.save(data));
        }
    };
    CervicalCancerScreeningComponent.prototype.subscribeToSaveResponse = function (result) {
        var _this = this;
        result.subscribe(function (res) { return _this.onSaveSuccess(res.body); }, function (res) {
            _this.onSaveError();
            _this.onError(res.message);
        });
    };
    CervicalCancerScreeningComponent.prototype.onSaveSuccess = function (result) {
        this.appLoaderService.close();
        this.isSaving = false;
        this.notification.showInfo('Cancer screening successfully saved');
        this.previousState();
    };
    CervicalCancerScreeningComponent.prototype.onSaveError = function () {
        this.isSaving = false;
        this.appLoaderService.close();
        //this.submitButton.disabled = true;
        this.notification.showError('Error occurred saving cancer screening; try again');
        //this.progressBar.mode = 'determinate';
    };
    CervicalCancerScreeningComponent.prototype.onError = function (errorMessage) {
        this.appLoaderService.close();
        this.notification.showError(errorMessage);
    };
    CervicalCancerScreeningComponent.ctorParameters = function () { return [
        { type: ClinicService },
        { type: CervicalCancerScreeningService },
        { type: NotificationService },
        { type: ActivatedRoute },
        { type: AppLoaderService }
    ]; };
    CervicalCancerScreeningComponent = tslib_1.__decorate([
        Component({
            selector: 'cancer-screening',
            template: "<div class=\"lamis-edit-form\">\n    <div class=\"lamis-edit-form-container\">\n        <form name=\"form\" role=\"form\" novalidate (ngSubmit)=\"save()\" #screeningForm=\"ngForm\">\n            <mat-card class=\"default\">\n                <mat-card-content *ngIf=\"patient\">\n                    <div class=\"row\">\n                        <div class=\"col-md-6\">\n                            <mat-form-field class=\"full-width\">\n                                <input matInput [matDatepicker]=\"picker\"\n                                       placeholder=\"Date of Screening\"\n                                       [(ngModel)]=\"entity.dateScreened\"\n                                       #visit=\"ngModel\"\n                                       [max]=\"today\"\n                                       [min]=\"patient.dateBirth\"\n                                       name=\"visit\"\n                                       required>\n                                <mat-datepicker-toggle\n                                        matSuffix\n                                        [for]=\"picker\">\n                                </mat-datepicker-toggle>\n                                <mat-datepicker #picker></mat-datepicker>\n                                <mat-error\n                                        *ngIf=\"visit.errors && (visit.dirty || visit.touched) && (visit.errors.required)\">\n                                    Date of Screening is required\n                                </mat-error>\n                                <mat-error\n                                        *ngIf=\"visit.errors && (visit.dirty || visit.touched) && (visit.errors.min)\">\n                                    Date of Screening cannot be before {{patient.dateBirth}}\n                                </mat-error>\n                                <mat-error\n                                        *ngIf=\"visit.errors && (visit.dirty || visit.touched) && (visit.errors.max)\">\n                                    Date of Screening cannot be in the future\n                                </mat-error>\n                            </mat-form-field>\n                        </div>\n                    </div>\n                    <div class=\"row\">\n                        <div class=\"col-md-6\">\n                            <mat-form-field class=\"full-width\">\n                                <mat-label>Screening Type</mat-label>\n                                <mat-select name=\"type\" [(ngModel)]=\"entity.screeningType\" #type=\"ngModel\" required>\n                                    <mat-option></mat-option>\n                                    <mat-option [value]=\"'FIRST_TIME'\">First Time</mat-option>\n                                    <mat-option [value]=\"'FOLLOWUP'\">Followup after previous negative result or\n                                        suspected cancer\n                                    </mat-option>\n                                    <mat-option [value]=\"'POST_TREATMENT_FOLLOWUP'\">Post-treatment Followup</mat-option>\n                                </mat-select>\n                                <mat-error\n                                        *ngIf=\"type.errors && (type.dirty || type.touched) && (type.errors.required)\">\n                                    Screening type is required\n                                </mat-error>\n                            </mat-form-field>\n                        </div>\n                        <div class=\"col-md-6\">\n                            <mat-form-field class=\"full-width\">\n                                <mat-label>Screening Method</mat-label>\n                                <mat-select name=\"method\" [(ngModel)]=\"entity.screeningMethod\" #method=\"ngModel\"\n                                            required>\n                                    <mat-option></mat-option>\n                                    <mat-option [value]=\"'VIA'\">Visual Inspection with Acetric Acid (VIA)</mat-option>\n                                    <mat-option [value]=\"'VILI'\">Visual Inspection with Lugos Iodine (VILI)</mat-option>\n                                    <mat-option [value]=\"'PAP_SMEAR'\">PAP Smear</mat-option>\n                                </mat-select>\n                                <mat-error\n                                        *ngIf=\"method.errors && (method.dirty || method.touched) && (method.errors.required)\">\n                                    Screening method is required\n                                </mat-error>\n                            </mat-form-field>\n                        </div>\n                    </div>\n                    <div class=\"row\">\n                        <div class=\"col-md-6\">\n                            <mat-form-field class=\"full-width\">\n                                <mat-label>Result of Screening</mat-label>\n                                <mat-select name=\"result\" [(ngModel)]=\"entity.screeningResult\" #result=\"ngModel\"\n                                            required>\n                                    <mat-option></mat-option>\n                                    <mat-option [value]=\"'NEGATIVE'\">Negative</mat-option>\n                                    <mat-option [value]=\"'POSITIVE'\">Positive</mat-option>\n                                    <mat-option [value]=\"'SUSPICIOUS'\">Suspicious Cancerous Lesions</mat-option>\n                                </mat-select>\n                                <mat-error\n                                        *ngIf=\"result.errors && (result.dirty || result.touched) && (result.errors.required)\">\n                                    Result of Screening is required\n                                </mat-error>\n                            </mat-form-field>\n                        </div>\n                        <div class=\"col-md-6\" *ngIf=\"entity.screeningResult === 'POSITIVE'\">\n                            <mat-checkbox [(ngModel)]=\"entity.referredForTreatment\"\n                                          name=\"uibn\"\n                            >\n                                Referred for Treatment?\n                            </mat-checkbox>\n                        </div>\n                    </div>\n                    <div class=\"row\" *ngIf=\"entity.referredForTreatment\">\n                        <div class=\"col-md-6\">\n                            <mat-form-field class=\"full-width\" *ngIf=\"entity.dateScreened\">\n                                <input matInput [matDatepicker]=\"picker1\"\n                                       placeholder=\"Date Treated\"\n                                       [(ngModel)]=\"entity.dateTreated\"\n                                       #treat=\"ngModel\"\n                                       [max]=\"today\"\n                                       [min]=\"entity.dateScreened\"\n                                       name=\"treat\"\n                                       required>\n                                <mat-datepicker-toggle\n                                        matSuffix\n                                        [for]=\"picker1\">\n                                </mat-datepicker-toggle>\n                                <mat-datepicker #picker1></mat-datepicker>\n                                <mat-error\n                                        *ngIf=\"treat.errors && (treat.dirty || treat.touched) && (treat.errors.required)\">\n                                    Date Treated is required\n                                </mat-error>\n                                <mat-error\n                                        *ngIf=\"treat.errors && (treat.dirty || treat.touched) && (treat.errors.min)\">\n                                    Date Treated cannot be before {{entity.dateScreened}}\n                                </mat-error>\n                                <mat-error\n                                        *ngIf=\"treat.errors && (treat.dirty || treat.touched) && (treat.errors.max)\">\n                                    Date Treated cannot be in the future\n                                </mat-error>\n                            </mat-form-field>\n                        </div>\n                        <div class=\"col-md-6\">\n                            <mat-form-field class=\"full-width\">\n                                <mat-label>Precancerous Lesions Treatment Method</mat-label>\n                                <mat-select name=\"pc\" [(ngModel)]=\"entity.precancerousLesionsTreatmentMethod\"\n                                            #pc=\"ngModel\" required>\n                                    <mat-option></mat-option>\n                                    <mat-option [value]=\"'CRYOTHERAPY'\">Cryotherapy</mat-option>\n                                    <mat-option [value]=\"'THERMAL_ABLATION'\">Thermal Ablation/ Thermocoagulation\n                                    </mat-option>\n                                    <mat-option [value]=\"'LEETZ_LEEP'\">LEETZ/ LEEP</mat-option>\n                                    <mat-option [value]=\"'CONIZATION'\">Conization Knifer/ Lagor</mat-option>\n                                </mat-select>\n                                <mat-error\n                                        *ngIf=\"pc.errors && (pc.dirty || pc.touched) && (pc.errors.required)\">\n                                    Treatment method is required\n                                </mat-error>\n                            </mat-form-field>\n                        </div>\n                    </div>\n                </mat-card-content>\n                <mat-card-actions class=\"lamis-edit-form-actions\">\n                    <button mat-raised-button type=\"button\" (click)=\"previousState()\">Back</button>\n                    <button mat-raised-button color='primary'\n                            [disabled]=\"screeningForm.invalid || isSaving\"\n                            type=\"submit\">\n                        {{!!observation ? 'Update' : 'Save'}}\n                    </button>\n                </mat-card-actions>\n            </mat-card>\n        </form>\n    </div>\n</div>\n"
        }),
        tslib_1.__metadata("design:paramtypes", [ClinicService,
            CervicalCancerScreeningService,
            NotificationService,
            ActivatedRoute,
            AppLoaderService])
    ], CervicalCancerScreeningComponent);
    return CervicalCancerScreeningComponent;
}());
export { CervicalCancerScreeningComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2VydmljYWwtY2FuY2VyLXNjcmVlbmluZy5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9sYW1pcy1jbGluaWMtMS40LjAvIiwic291cmNlcyI6WyJsaWIvY29tcG9uZW50cy9jZXJ2aWNhbC1jYW5jZXItc2NyZWVuaW5nL2NlcnZpY2FsLWNhbmNlci1zY3JlZW5pbmcuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUMsU0FBUyxFQUFTLE1BQU0sZUFBZSxDQUFDO0FBRWhELE9BQU8sS0FBSyxPQUFPLE1BQU0sUUFBUSxDQUFDO0FBR2xDLE9BQU8sRUFBQyxhQUFhLEVBQUMsTUFBTSwrQkFBK0IsQ0FBQztBQUM1RCxPQUFPLEVBQUMsbUJBQW1CLEVBQUMsTUFBTSxvQkFBb0IsQ0FBQztBQUN2RCxPQUFPLEVBQUMsY0FBYyxFQUFDLE1BQU0saUJBQWlCLENBQUM7QUFDL0MsT0FBTyxFQUFDLGdCQUFnQixFQUFFLFdBQVcsRUFBQyxNQUFNLGlCQUFpQixDQUFDO0FBQzlELE9BQU8sRUFBQyw4QkFBOEIsRUFBQyxNQUFNLGtEQUFrRCxDQUFDO0FBRWhHLElBQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQztBQU12QjtJQU9JLDBDQUFvQixhQUE0QixFQUM1QixnQkFBZ0QsRUFDOUMsWUFBaUMsRUFDakMsY0FBOEIsRUFDaEMsZ0JBQWtDO1FBSmxDLGtCQUFhLEdBQWIsYUFBYSxDQUFlO1FBQzVCLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBZ0M7UUFDOUMsaUJBQVksR0FBWixZQUFZLENBQXFCO1FBQ2pDLG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtRQUNoQyxxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBVnRELFdBQU0sR0FBNEIsRUFBRSxDQUFDO1FBRXJDLGdCQUFXLEdBQWdCLEVBQUUsQ0FBQztRQUM5QixVQUFLLEdBQUcsTUFBTSxFQUFFLENBQUM7UUFDakIsYUFBUSxHQUFZLEtBQUssQ0FBQztJQU8xQixDQUFDO0lBRUQsbURBQVEsR0FBUjtRQUFBLGlCQXVCQztRQXRCRyxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsVUFBQyxFQUFRO2dCQUFQLGtCQUFNO1lBQ3ZDLEtBQUksQ0FBQyxXQUFXLEdBQUcsQ0FBQyxDQUFDLE1BQU0sSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUM7WUFDbEUsSUFBSSxDQUFDLENBQUMsS0FBSSxDQUFDLFdBQVcsRUFBRTtnQkFDcEIsS0FBSSxDQUFDLE1BQU0sR0FBRyxLQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQzthQUN2QztpQkFBTTtnQkFDSCxLQUFJLENBQUMsV0FBVyxHQUFHLEVBQUUsQ0FBQzthQUN6QjtZQUVELElBQUksS0FBSSxDQUFDLE1BQU0sS0FBSyxTQUFTLEVBQUU7Z0JBQzNCLEtBQUksQ0FBQyxNQUFNLEdBQUcsRUFBRSxDQUFDO2FBQ3BCO1lBQ0QsSUFBTSxTQUFTLEdBQUcsS0FBSSxDQUFDLGNBQWMsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsQ0FBQztZQUN6RSxLQUFJLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsQ0FBQyxTQUFTLENBQUMsVUFBQyxHQUFHO2dCQUNuRCxLQUFJLENBQUMsT0FBTyxHQUFHLEdBQUcsQ0FBQztnQkFDbkIsSUFBSSxDQUFDLENBQUMsS0FBSSxDQUFDLE1BQU0sRUFBRTtvQkFDZixLQUFJLENBQUMsZ0JBQWdCLENBQUMscUJBQXFCLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxVQUFBLENBQUM7d0JBQzNELEtBQUksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLElBQUksSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQzt3QkFDcEMsS0FBSSxDQUFDLFdBQVcsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDO29CQUM5QixDQUFDLENBQUMsQ0FBQztpQkFDTjtZQUNMLENBQUMsQ0FBQyxDQUFDO1FBQ1AsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRUQsd0RBQWEsR0FBYjtRQUNJLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDMUIsQ0FBQztJQUdELCtDQUFJLEdBQUo7UUFDSSxvQ0FBb0M7UUFDcEMsMENBQTBDO1FBQzFDLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsMkJBQTJCLENBQUMsQ0FBQztRQUV4RCxJQUFNLElBQUksR0FBRztZQUNULEVBQUUsRUFBRSxJQUFJLENBQUMsV0FBVyxJQUFJLElBQUksQ0FBQyxXQUFXLENBQUMsRUFBRSxJQUFJLElBQUk7WUFDbkQsT0FBTyxFQUFFLElBQUksQ0FBQyxPQUFPO1lBQ3JCLElBQUksRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDO1lBQ2xELFFBQVEsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVE7WUFDL0IsSUFBSSxFQUFFLDJCQUEyQjtZQUNqQyxJQUFJLEVBQUU7Z0JBQ0YsdUJBQXVCLEVBQUUsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsSUFBSSxDQUFDLE1BQU0sRUFBRTtvQkFDcEQsWUFBWSxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsWUFBWSxJQUFJLElBQUksSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDO3dCQUNsRixJQUFJLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUk7b0JBQ3ZELFdBQVcsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLFdBQVcsSUFBSSxJQUFJLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQzt3QkFDL0UsSUFBSSxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJO2lCQUN6RCxDQUFDO2FBQ0w7U0FDSixDQUFDO1FBQ0YsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxFQUFFLEVBQUU7WUFDdkIsSUFBSSxDQUFDLHVCQUF1QixDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztTQUNwRTthQUFNO1lBQ0gsSUFBSSxDQUFDLHVCQUF1QixDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztTQUNsRTtJQUNMLENBQUM7SUFFTyxrRUFBdUIsR0FBL0IsVUFBZ0MsTUFBcUM7UUFBckUsaUJBT0M7UUFORyxNQUFNLENBQUMsU0FBUyxDQUNaLFVBQUMsR0FBc0IsSUFBSyxPQUFBLEtBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUE1QixDQUE0QixFQUN4RCxVQUFDLEdBQXNCO1lBQ25CLEtBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUNuQixLQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUM5QixDQUFDLENBQUMsQ0FBQztJQUNYLENBQUM7SUFFTyx3REFBYSxHQUFyQixVQUFzQixNQUFXO1FBQzdCLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUM5QixJQUFJLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FBQztRQUN0QixJQUFJLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxxQ0FBcUMsQ0FBQyxDQUFDO1FBQ2xFLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztJQUN6QixDQUFDO0lBRU8sc0RBQVcsR0FBbkI7UUFDSSxJQUFJLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FBQztRQUN0QixJQUFJLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDOUIsb0NBQW9DO1FBQ3BDLElBQUksQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLG1EQUFtRCxDQUFDLENBQUM7UUFDakYsd0NBQXdDO0lBQzVDLENBQUM7SUFFUyxrREFBTyxHQUFqQixVQUFrQixZQUFvQjtRQUNsQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDOUIsSUFBSSxDQUFDLFlBQVksQ0FBQyxTQUFTLENBQUMsWUFBWSxDQUFDLENBQUM7SUFDOUMsQ0FBQzs7Z0JBNUZrQyxhQUFhO2dCQUNWLDhCQUE4QjtnQkFDaEMsbUJBQW1CO2dCQUNqQixjQUFjO2dCQUNkLGdCQUFnQjs7SUFYN0MsZ0NBQWdDO1FBSjVDLFNBQVMsQ0FBQztZQUNQLFFBQVEsRUFBRSxrQkFBa0I7WUFDNUIsMmlVQUF5RDtTQUM1RCxDQUFDO2lEQVFxQyxhQUFhO1lBQ1YsOEJBQThCO1lBQ2hDLG1CQUFtQjtZQUNqQixjQUFjO1lBQ2QsZ0JBQWdCO09BWDdDLGdDQUFnQyxDQXFHNUM7SUFBRCx1Q0FBQztDQUFBLEFBckdELElBcUdDO1NBckdZLGdDQUFnQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Q29tcG9uZW50LCBPbkluaXR9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtDZXJ2aWNhbENhbmNlclNjcmVlbmluZywgT2JzZXJ2YXRpb24sIFBhdGllbnR9IGZyb20gJy4uLy4uL21vZGVsL2NsaW5pYy5tb2RlbCc7XG5pbXBvcnQgKiBhcyBtb21lbnRfIGZyb20gJ21vbWVudCc7XG5pbXBvcnQge09ic2VydmFibGV9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtIdHRwRXJyb3JSZXNwb25zZSwgSHR0cFJlc3BvbnNlfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQge0NsaW5pY1NlcnZpY2V9IGZyb20gJy4uLy4uL3NlcnZpY2VzL2NsaW5pYy5zZXJ2aWNlJztcbmltcG9ydCB7Tm90aWZpY2F0aW9uU2VydmljZX0gZnJvbSAnQGFsZnJlc2NvL2FkZi1jb3JlJztcbmltcG9ydCB7QWN0aXZhdGVkUm91dGV9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5pbXBvcnQge0FwcExvYWRlclNlcnZpY2UsIERBVEVfRk9STUFUfSBmcm9tICdAbGFtaXMvd2ViLWNvcmUnO1xuaW1wb3J0IHtDZXJ2aWNhbENhbmNlclNjcmVlbmluZ1NlcnZpY2V9IGZyb20gJy4uLy4uL3NlcnZpY2VzL2NlcnZpY2FsLWNhbmNlci1zY3JlZW5pbmcuc2VydmljZSc7XG5cbmNvbnN0IG1vbWVudCA9IG1vbWVudF87XG5cbkBDb21wb25lbnQoe1xuICAgIHNlbGVjdG9yOiAnY2FuY2VyLXNjcmVlbmluZycsXG4gICAgdGVtcGxhdGVVcmw6ICcuL2NlcnZpY2FsLWNhbmNlci1zY3JlZW5pbmcuY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIENlcnZpY2FsQ2FuY2VyU2NyZWVuaW5nQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0IHtcbiAgICBlbnRpdHk6IENlcnZpY2FsQ2FuY2VyU2NyZWVuaW5nID0ge307XG4gICAgcGF0aWVudDogUGF0aWVudDtcbiAgICBvYnNlcnZhdGlvbjogT2JzZXJ2YXRpb24gPSB7fTtcbiAgICB0b2RheSA9IG1vbWVudCgpO1xuICAgIGlzU2F2aW5nOiBib29sZWFuID0gZmFsc2U7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGNsaW5pY1NlcnZpY2U6IENsaW5pY1NlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBzY3JlZW5pbmdTZXJ2aWNlOiBDZXJ2aWNhbENhbmNlclNjcmVlbmluZ1NlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJvdGVjdGVkIG5vdGlmaWNhdGlvbjogTm90aWZpY2F0aW9uU2VydmljZSxcbiAgICAgICAgICAgICAgICBwcm90ZWN0ZWQgYWN0aXZhdGVkUm91dGU6IEFjdGl2YXRlZFJvdXRlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgYXBwTG9hZGVyU2VydmljZTogQXBwTG9hZGVyU2VydmljZSkge1xuICAgIH1cblxuICAgIG5nT25Jbml0KCk6IHZvaWQge1xuICAgICAgICB0aGlzLmFjdGl2YXRlZFJvdXRlLmRhdGEuc3Vic2NyaWJlKCh7ZW50aXR5fSkgPT4ge1xuICAgICAgICAgICAgdGhpcy5vYnNlcnZhdGlvbiA9ICEhZW50aXR5ICYmIGVudGl0eS5ib2R5ID8gZW50aXR5LmJvZHkgOiBlbnRpdHk7XG4gICAgICAgICAgICBpZiAoISF0aGlzLm9ic2VydmF0aW9uKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5lbnRpdHkgPSB0aGlzLm9ic2VydmF0aW9uLmRhdGE7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMub2JzZXJ2YXRpb24gPSB7fTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHRoaXMuZW50aXR5ID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmVudGl0eSA9IHt9O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QgcGF0aWVudElkID0gdGhpcy5hY3RpdmF0ZWRSb3V0ZS5zbmFwc2hvdC5wYXJhbU1hcC5nZXQoJ3BhdGllbnRJZCcpO1xuICAgICAgICAgICAgdGhpcy5jbGluaWNTZXJ2aWNlLmdldFBhdGllbnQocGF0aWVudElkKS5zdWJzY3JpYmUoKHJlcykgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMucGF0aWVudCA9IHJlcztcbiAgICAgICAgICAgICAgICBpZiAoISF0aGlzLmVudGl0eSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnNjcmVlbmluZ1NlcnZpY2UuZ2V0U2NyZWVuaW5nQnlQYXRpZW50KHJlcy5pZCkuc3Vic2NyaWJlKHIgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5lbnRpdHkgPSByLmJvZHkgJiYgci5ib2R5LmRhdGE7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9ic2VydmF0aW9uID0gci5ib2R5O1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJldmlvdXNTdGF0ZSgpIHtcbiAgICAgICAgd2luZG93Lmhpc3RvcnkuYmFjaygpO1xuICAgIH1cblxuXG4gICAgc2F2ZSgpIHtcbiAgICAgICAgLy90aGlzLnN1Ym1pdEJ1dHRvbi5kaXNhYmxlZCA9IHRydWU7XG4gICAgICAgIC8vdGhpcy5wcm9ncmVzc0Jhci5tb2RlID0gJ2luZGV0ZXJtaW5hdGUnO1xuICAgICAgICB0aGlzLmlzU2F2aW5nID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5hcHBMb2FkZXJTZXJ2aWNlLm9wZW4oJ1NhdmluZyBjYW5jZXIgc2NyZWVuaW5nLi4nKTtcblxuICAgICAgICBjb25zdCBkYXRhID0ge1xuICAgICAgICAgICAgaWQ6IHRoaXMub2JzZXJ2YXRpb24gJiYgdGhpcy5vYnNlcnZhdGlvbi5pZCB8fCBudWxsLFxuICAgICAgICAgICAgcGF0aWVudDogdGhpcy5wYXRpZW50LFxuICAgICAgICAgICAgZGF0ZTogdGhpcy5lbnRpdHkuZGF0ZVNjcmVlbmVkLmZvcm1hdChEQVRFX0ZPUk1BVCksXG4gICAgICAgICAgICBmYWNpbGl0eTogdGhpcy5wYXRpZW50LmZhY2lsaXR5LFxuICAgICAgICAgICAgdHlwZTogJ0NFUlZJQ0FMX0NBTkNFUl9TQ1JFRU5JTkcnLFxuICAgICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgICAgIGNlcnZpY2FsQ2FuY2VyU2NyZWVuaW5nOiBPYmplY3QuYXNzaWduKHt9LCB0aGlzLmVudGl0eSwge1xuICAgICAgICAgICAgICAgICAgICBkYXRlU2NyZWVuZWQ6IHRoaXMuZW50aXR5LmRhdGVTY3JlZW5lZCAhPSBudWxsICYmIHRoaXMuZW50aXR5LmRhdGVTY3JlZW5lZC5pc1ZhbGlkKCkgP1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5lbnRpdHkuZGF0ZVNjcmVlbmVkLmZvcm1hdChEQVRFX0ZPUk1BVCkgOiBudWxsLFxuICAgICAgICAgICAgICAgICAgICBkYXRlVHJlYXRlZDogdGhpcy5lbnRpdHkuZGF0ZVRyZWF0ZWQgIT0gbnVsbCAmJiB0aGlzLmVudGl0eS5kYXRlVHJlYXRlZC5pc1ZhbGlkKCkgP1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5lbnRpdHkuZGF0ZVRyZWF0ZWQuZm9ybWF0KERBVEVfRk9STUFUKSA6IG51bGwsXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgaWYgKCEhdGhpcy5vYnNlcnZhdGlvbi5pZCkge1xuICAgICAgICAgICAgdGhpcy5zdWJzY3JpYmVUb1NhdmVSZXNwb25zZSh0aGlzLnNjcmVlbmluZ1NlcnZpY2UudXBkYXRlKGRhdGEpKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuc3Vic2NyaWJlVG9TYXZlUmVzcG9uc2UodGhpcy5zY3JlZW5pbmdTZXJ2aWNlLnNhdmUoZGF0YSkpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdWJzY3JpYmVUb1NhdmVSZXNwb25zZShyZXN1bHQ6IE9ic2VydmFibGU8SHR0cFJlc3BvbnNlPGFueT4+KSB7XG4gICAgICAgIHJlc3VsdC5zdWJzY3JpYmUoXG4gICAgICAgICAgICAocmVzOiBIdHRwUmVzcG9uc2U8YW55PikgPT4gdGhpcy5vblNhdmVTdWNjZXNzKHJlcy5ib2R5KSxcbiAgICAgICAgICAgIChyZXM6IEh0dHBFcnJvclJlc3BvbnNlKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5vblNhdmVFcnJvcigpO1xuICAgICAgICAgICAgICAgIHRoaXMub25FcnJvcihyZXMubWVzc2FnZSk7XG4gICAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIG9uU2F2ZVN1Y2Nlc3MocmVzdWx0OiBhbnkpIHtcbiAgICAgICAgdGhpcy5hcHBMb2FkZXJTZXJ2aWNlLmNsb3NlKCk7XG4gICAgICAgIHRoaXMuaXNTYXZpbmcgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5ub3RpZmljYXRpb24uc2hvd0luZm8oJ0NhbmNlciBzY3JlZW5pbmcgc3VjY2Vzc2Z1bGx5IHNhdmVkJyk7XG4gICAgICAgIHRoaXMucHJldmlvdXNTdGF0ZSgpO1xuICAgIH1cblxuICAgIHByaXZhdGUgb25TYXZlRXJyb3IoKSB7XG4gICAgICAgIHRoaXMuaXNTYXZpbmcgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5hcHBMb2FkZXJTZXJ2aWNlLmNsb3NlKCk7XG4gICAgICAgIC8vdGhpcy5zdWJtaXRCdXR0b24uZGlzYWJsZWQgPSB0cnVlO1xuICAgICAgICB0aGlzLm5vdGlmaWNhdGlvbi5zaG93RXJyb3IoJ0Vycm9yIG9jY3VycmVkIHNhdmluZyBjYW5jZXIgc2NyZWVuaW5nOyB0cnkgYWdhaW4nKTtcbiAgICAgICAgLy90aGlzLnByb2dyZXNzQmFyLm1vZGUgPSAnZGV0ZXJtaW5hdGUnO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBvbkVycm9yKGVycm9yTWVzc2FnZTogc3RyaW5nKSB7XG4gICAgICAgIHRoaXMuYXBwTG9hZGVyU2VydmljZS5jbG9zZSgpO1xuICAgICAgICB0aGlzLm5vdGlmaWNhdGlvbi5zaG93RXJyb3IoZXJyb3JNZXNzYWdlKTtcbiAgICB9XG5cbn1cbiJdfQ==