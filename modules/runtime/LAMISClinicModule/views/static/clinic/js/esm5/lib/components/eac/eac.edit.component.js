import * as tslib_1 from "tslib";
import { Component } from '@angular/core';
import * as moment_ from 'moment';
import { ClinicService } from '../../services/clinic.service';
import { NotificationService } from '@alfresco/adf-core';
import { ActivatedRoute } from '@angular/router';
import { AppLoaderService } from '@lamis/web-core';
import { EacService } from '../../services/eac.service';
import { catchError, tap } from 'rxjs/operators';
var moment = moment_;
var EacEditComponent = /** @class */ (function () {
    function EacEditComponent(clinicService, eacService, notification, activatedRoute, appLoaderService) {
        this.clinicService = clinicService;
        this.eacService = eacService;
        this.notification = notification;
        this.activatedRoute = activatedRoute;
        this.appLoaderService = appLoaderService;
        this.today = moment();
        this.isSaving = false;
    }
    EacEditComponent.prototype.createEntity = function () {
        return {};
    };
    EacEditComponent.prototype.ngOnInit = function () {
        var _this = this;
        this.activatedRoute.data.subscribe(function (_a) {
            var entity = _a.entity;
            _this.entity = !!entity && entity.body ? entity.body : entity;
            if (_this.entity === undefined) {
                _this.entity = _this.createEntity();
            }
            var patientId = _this.activatedRoute.snapshot.paramMap.get('patientId');
            _this.clinicService.getPatient(patientId).subscribe(function (res) {
                _this.entity.patient = res;
                _this.entity.facility = res.facility;
                _this.dateRegistration = res.dateRegistration;
                _this.updateMinDates(res.id, moment());
                if (!_this.entity.id) {
                    _this.eacService.getLatestByPatient(res.uuid).subscribe(function (r) {
                        _this.entity = r.ok ? r.body : _this.createEntity();
                        _this.repeatVLMin = _this.entity.dateEac3 ? _this.entity.dateEac3.clone().add(1, 'day') :
                            _this.entity.dateLastViralLoad;
                        _this.eac2Min = _this.entity.dateEac1 ? _this.entity.dateEac1.clone().add(2, 'week') :
                            _this.entity.dateLastViralLoad;
                        _this.eac3Min = _this.entity.dateEac2 ? _this.entity.dateEac2.clone().add(2, 'week') :
                            _this.entity.dateLastViralLoad;
                    });
                }
            });
        });
    };
    EacEditComponent.prototype.updateMinDates = function (id, date) {
        var _this = this;
        this.eacService.getLatestViralLoadByPatient(id, date).pipe(tap(function (r) {
            _this.entity.dateLastViralLoad = moment(r.laboratory.dateResultReceived);
            _this.entity.lastViralLoad = r.result;
            _this.eac1Min = _this.entity.dateLastViralLoad.clone().add(1, 'day');
            _this.eac2Min = _this.entity.dateEac1 ? _this.entity.dateEac1.clone().add(2, 'week') :
                _this.entity.dateLastViralLoad;
            _this.eac3Min = _this.entity.dateEac2 ? _this.entity.dateEac2.clone().add(2, 'week') :
                _this.entity.dateLastViralLoad;
            _this.repeatVLMin = _this.entity.dateEac3 ? _this.entity.dateEac3.clone().add(1, 'day') :
                _this.entity.dateLastViralLoad;
        }), catchError(function (err) {
            _this.entity.dateLastViralLoad = null;
            _this.entity.lastViralLoad = null;
            _this.eac1Min = _this.entity.patient.dateRegistration.clone().add(1, 'day');
            _this.eac2Min = _this.entity.dateEac1 ? _this.entity.dateEac1.clone().add(2, 'week') :
                _this.entity.dateLastViralLoad;
            _this.eac3Min = _this.entity.dateEac2 ? _this.entity.dateEac2.clone().add(2, 'week') :
                _this.entity.dateLastViralLoad;
            _this.repeatVLMin = _this.entity.dateEac3 ? _this.entity.dateEac3.clone().add(1, 'day') :
                _this.entity.dateLastViralLoad;
            return null;
        }));
    };
    EacEditComponent.prototype.dateEac1Changed = function (date) {
        this.eac2Min = date.clone().add(2, 'weeks');
        this.updateMinDates(this.entity.patient.id, date);
    };
    EacEditComponent.prototype.dateEac2Changed = function (date) {
        this.eac3Min = date.clone().add(2, 'weeks');
    };
    EacEditComponent.prototype.dateEac3Changed = function (date) {
        this.repeatVLMin = date.clone().add(1, 'days');
        this.repeatVLMax = date.clone().add(6, 'months');
    };
    EacEditComponent.prototype.save = function () {
        //this.submitButton.disabled = true;
        //this.progressBar.mode = 'indeterminate';
        this.isSaving = true;
        this.appLoaderService.open('Saving EAC session..');
        if (this.entity.id !== undefined) {
            this.subscribeToSaveResponse(this.eacService.update(this.entity));
        }
        else {
            this.subscribeToSaveResponse(this.eacService.create(this.entity));
        }
    };
    EacEditComponent.prototype.previousState = function () {
        window.history.back();
    };
    EacEditComponent.prototype.subscribeToSaveResponse = function (result) {
        var _this = this;
        result.subscribe(function (res) { return _this.onSaveSuccess(res.body); }, function (res) {
            _this.onSaveError();
            _this.onError(res.message);
        });
    };
    EacEditComponent.prototype.onSaveSuccess = function (result) {
        this.appLoaderService.close();
        this.isSaving = false;
        this.notification.openSnackMessage('EAC session successfully saved');
        this.previousState();
    };
    EacEditComponent.prototype.onSaveError = function () {
        this.isSaving = false;
        this.appLoaderService.close();
        //this.submitButton.disabled = true;
        this.notification.showError('Error occurred saving EAC session; try again');
        //this.progressBar.mode = 'determinate';
    };
    EacEditComponent.prototype.onError = function (errorMessage) {
        this.appLoaderService.close();
        this.notification.showError(errorMessage);
    };
    EacEditComponent.ctorParameters = function () { return [
        { type: ClinicService },
        { type: EacService },
        { type: NotificationService },
        { type: ActivatedRoute },
        { type: AppLoaderService }
    ]; };
    EacEditComponent = tslib_1.__decorate([
        Component({
            selector: 'eac-edit',
            template: "<div class=\"lamis-edit-form\">\n    <div class=\"lamis-edit-form-container\">\n        <mat-card class=\"default\">\n            <mat-card-content>\n                <mat-progress-bar mode=\"determinate\" class=\"session-progress\"></mat-progress-bar>\n            </mat-card-content>\n        </mat-card>\n        <form name=\"form\" role=\"form\" novalidate (ngSubmit)=\"save()\" #clinicForm=\"ngForm\">\n            <mat-card class=\"default\">\n                <mat-card-content *ngIf=\"entity.patient\">\n                    <div class=\"row\">\n                        <div class=\"col-md-6\">\n                            <mat-form-field>\n                                <mat-label>Date Last Viral Load</mat-label>\n                                <input matInput\n                                       [value]=\"entity.dateLastViralLoad && entity.dateLastViralLoad.format('DD MMM, YYYY')\"\n                                       disabled>\n                            </mat-form-field>\n                        </div>\n                        <div class=\"col-md-6\">\n                            <mat-form-field>\n                                <input matInput [value]=\"entity.lastViralLoad\" disabled>\n                            </mat-form-field>\n                        </div>\n                    </div>\n                    <div>\n                        <mat-form-field class=\"full-width\">\n                            <input matInput [matDatepicker]=\"picker\"\n                                   placeholder=\"Date of 1st EAC Session\"\n                                   [(ngModel)]=\"entity.dateEac1\"\n                                   #visit=\"ngModel\"\n                                   (dateChange)=\"dateEac1Changed($event.value)\"\n                                   [max]=\"today\"\n                                   [min]=\"eac1Min\"\n                                   name=\"visit\"\n                                   required>\n                            <mat-datepicker-toggle\n                                    matSuffix\n                                    [for]=\"picker\">\n                            </mat-datepicker-toggle>\n                            <mat-datepicker #picker></mat-datepicker>\n                            <mat-error\n                                    *ngIf=\"visit.errors && (visit.dirty || visit.touched) && (visit.errors.required)\">\n                                Date of first EAC session is required\n                            </mat-error>\n                            <mat-error\n                                    *ngIf=\"visit.errors && (visit.dirty || visit.touched) && (visit.errors.min)\">\n                                Date of first EAC session cannot be before {{eac1Min | date: 'dd MMM, yyyy'}}\n                            </mat-error>\n                            <mat-error\n                                    *ngIf=\"visit.errors && (visit.dirty || visit.touched) && (visit.errors.max)\">\n                                Date of first EAC session cannot be after {{today | date: 'dd MMM, yyyy'}}\n                            </mat-error>\n                        </mat-form-field>\n                    </div>\n                    <div>\n                        <mat-form-field class=\"full-width\" *ngIf=\"entity.id && !!eac2Min\">\n                            <input matInput [matDatepicker]=\"picker2\"\n                                   placeholder=\"Date of 2nd EAC Session\"\n                                   [(ngModel)]=\"entity.dateEac2\"\n                                   #visit2=\"ngModel\"\n                                   (dateChange)=\"dateEac2Changed($event.value)\"\n                                   [max]=\"today\"\n                                   [min]=\"eac2Min\"\n                                   name=\"visit2\">\n                            <mat-datepicker-toggle\n                                    matSuffix\n                                    [for]=\"picker2\">\n                            </mat-datepicker-toggle>\n                            <mat-datepicker #picker2></mat-datepicker>\n                            <mat-error\n                                    *ngIf=\"visit2.errors && (visit2.dirty || visit2.touched) && (visit2.errors.required)\">\n                                Date of second EAC session is required\n                            </mat-error>\n                            <mat-error\n                                    *ngIf=\"visit2.errors && (visit2.dirty || visit2.touched) && (visit2.errors.min)\">\n                                Date of second EAC session cannot be before {{eac2Min | date: 'dd MMM, yyyy'}}\n                            </mat-error>\n                            <mat-error\n                                    *ngIf=\"visit2.errors && (visit2.dirty || visit2.touched) && (visit2.errors.max)\">\n                                Date of second EAC session cannot be after {{today | date: 'dd MMM, yyyy'}}\n                            </mat-error>\n                        </mat-form-field>\n                    </div>\n                    <div>\n                        <mat-form-field class=\"full-width\" *ngIf=\"entity.dateEac2 && !!eac3Min\">\n                            <input matInput [matDatepicker]=\"picker3\"\n                                   placeholder=\"Date of 3rd EAC Session\"\n                                   [(ngModel)]=\"entity.dateEac3\"\n                                   #visit3=\"ngModel\"\n                                   (dateChange)=\"dateEac3Changed($event.value)\"\n                                   [max]=\"today\"\n                                   [min]=\"eac3Min\"\n                                   name=\"visit3\">\n                            <mat-datepicker-toggle\n                                    matSuffix\n                                    [for]=\"picker3\">\n                            </mat-datepicker-toggle>\n                            <mat-datepicker #picker3></mat-datepicker>\n                            <mat-error\n                                    *ngIf=\"visit3.errors && (visit3.dirty || visit3.touched) && (visit3.errors.required)\">\n                                Date of third EAC session is required\n                            </mat-error>\n                            <mat-error\n                                    *ngIf=\"visit3.errors && (visit3.dirty || visit3.touched) && (visit3.errors.min)\">\n                                Date of third EAC session cannot be before {{eac3Min | date: 'dd MMM, yyyy'}}\n                            </mat-error>\n                            <mat-error\n                                    *ngIf=\"visit3.errors && (visit3.dirty || visit3.touched) && (visit3.errors.max)\">\n                                Date of third EAC session cannot be after {{today | date: 'dd MMM, yyyy'}}\n                            </mat-error>\n                        </mat-form-field>\n                    </div>\n                    <div>\n                        <mat-form-field class=\"full-width\" *ngIf=\"entity.dateEac3 && !!repeatVLMin\">\n                            <input matInput [matDatepicker]=\"picker4\"\n                                   placeholder=\"Date of Repeat VL Sample Collection\"\n                                   [(ngModel)]=\"entity.dateSampleCollected\"\n                                   #visit4=\"ngModel\"\n                                   [max]=\"repeatVLMax\"\n                                   [min]=\"repeatVLMin\"\n                                   name=\"repeat\">\n                            <mat-datepicker-toggle\n                                    matSuffix\n                                    [for]=\"picker4\">\n                            </mat-datepicker-toggle>\n                            <mat-datepicker #picker4></mat-datepicker>\n                            <mat-error\n                                    *ngIf=\"visit4.errors && (visit4.dirty || visit4.touched) && (visit4.errors.required)\">\n                                Date of Repeat VL Sample Collection is required\n                            </mat-error>\n                            <mat-error\n                                    *ngIf=\"visit4.errors && (visit4.dirty || visit4.touched) && (visit4.errors.min)\">\n                                Date of Repeat VL Sample Collection cannot be\n                                before {{repeatVLMin | date:'dd MMM, yyyy'}}\n                            </mat-error>\n                            <mat-error\n                                    *ngIf=\"visit4.errors && (visit4.dirty || visit4.touched) && (visit4.errors.max)\">\n                                Date of Repeat VL Sample Collection cannot be\n                                after {{repeatVLMax | date:'dd MMM, yyyy'}}\n                            </mat-error>\n                        </mat-form-field>\n                    </div>\n                    <div>\n                        <mat-form-field class=\"full-width\">\n                            <textarea matInput placeholder=\"Notes\"\n                                      cols=\"30\"\n                                      rows=\"3\"\n                                      name=\"notes\"\n                                      #note=\"ngModel\" [(ngModel)]=\"entity.notes\"></textarea>\n                        </mat-form-field>\n                    </div>\n                    <mat-card-actions class=\"lamis-edit-form-actions\">\n                        <button mat-raised-button type=\"button\" (click)=\"previousState()\">Back</button>\n                        <button mat-raised-button color='primary'\n                                [disabled]=\"clinicForm.invalid || isSaving\"\n                                type=\"submit\">\n                            {{entity.id !== undefined ? 'Update' : 'Save'}}\n                        </button>\n                    </mat-card-actions>\n                </mat-card-content>\n            </mat-card>\n        </form>\n    </div>\n</div>\n"
        }),
        tslib_1.__metadata("design:paramtypes", [ClinicService,
            EacService,
            NotificationService,
            ActivatedRoute,
            AppLoaderService])
    ], EacEditComponent);
    return EacEditComponent;
}());
export { EacEditComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWFjLmVkaXQuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vbGFtaXMtY2xpbmljLTEuNC4wLyIsInNvdXJjZXMiOlsibGliL2NvbXBvbmVudHMvZWFjL2VhYy5lZGl0LmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFDLFNBQVMsRUFBUyxNQUFNLGVBQWUsQ0FBQztBQUNoRCxPQUFPLEtBQUssT0FBTyxNQUFNLFFBQVEsQ0FBQztBQUlsQyxPQUFPLEVBQUMsYUFBYSxFQUFDLE1BQU0sK0JBQStCLENBQUM7QUFDNUQsT0FBTyxFQUFDLG1CQUFtQixFQUFDLE1BQU0sb0JBQW9CLENBQUM7QUFDdkQsT0FBTyxFQUFDLGNBQWMsRUFBQyxNQUFNLGlCQUFpQixDQUFDO0FBQy9DLE9BQU8sRUFBQyxnQkFBZ0IsRUFBQyxNQUFNLGlCQUFpQixDQUFDO0FBRWpELE9BQU8sRUFBQyxVQUFVLEVBQUMsTUFBTSw0QkFBNEIsQ0FBQztBQUN0RCxPQUFPLEVBQUMsVUFBVSxFQUFFLEdBQUcsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBRS9DLElBQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQztBQU92QjtJQVlJLDBCQUFvQixhQUE0QixFQUM1QixVQUFzQixFQUNwQixZQUFpQyxFQUNqQyxjQUE4QixFQUNoQyxnQkFBa0M7UUFKbEMsa0JBQWEsR0FBYixhQUFhLENBQWU7UUFDNUIsZUFBVSxHQUFWLFVBQVUsQ0FBWTtRQUNwQixpQkFBWSxHQUFaLFlBQVksQ0FBcUI7UUFDakMsbUJBQWMsR0FBZCxjQUFjLENBQWdCO1FBQ2hDLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFidEQsVUFBSyxHQUFHLE1BQU0sRUFBRSxDQUFDO1FBT2pCLGFBQVEsR0FBWSxLQUFLLENBQUM7SUFPMUIsQ0FBQztJQUVELHVDQUFZLEdBQVo7UUFDSSxPQUFZLEVBQUUsQ0FBQztJQUNuQixDQUFDO0lBRUQsbUNBQVEsR0FBUjtRQUFBLGlCQTJCQztR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QUQsdUJBQUM7Q0FBQSxBQXpJRCxJQXlJQztTQXpJWSxnQkFBZ0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0NvbXBvbmVudCwgT25Jbml0fSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCAqIGFzIG1vbWVudF8gZnJvbSAnbW9tZW50JztcbmltcG9ydCB7TW9tZW50fSBmcm9tICdtb21lbnQnO1xuaW1wb3J0IHtPYnNlcnZhYmxlfSBmcm9tICdyeGpzJztcbmltcG9ydCB7SHR0cEVycm9yUmVzcG9uc2UsIEh0dHBSZXNwb25zZX0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHtDbGluaWNTZXJ2aWNlfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9jbGluaWMuc2VydmljZSc7XG5pbXBvcnQge05vdGlmaWNhdGlvblNlcnZpY2V9IGZyb20gJ0BhbGZyZXNjby9hZGYtY29yZSc7XG5pbXBvcnQge0FjdGl2YXRlZFJvdXRlfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xuaW1wb3J0IHtBcHBMb2FkZXJTZXJ2aWNlfSBmcm9tICdAbGFtaXMvd2ViLWNvcmUnO1xuaW1wb3J0IHtFQUMsIFBhdGllbnR9IGZyb20gJy4uLy4uL21vZGVsL2NsaW5pYy5tb2RlbCc7XG5pbXBvcnQge0VhY1NlcnZpY2V9IGZyb20gJy4uLy4uL3NlcnZpY2VzL2VhYy5zZXJ2aWNlJztcbmltcG9ydCB7Y2F0Y2hFcnJvciwgdGFwfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmNvbnN0IG1vbWVudCA9IG1vbWVudF87XG5cblxuQENvbXBvbmVudCh7XG4gICAgc2VsZWN0b3I6ICdlYWMtZWRpdCcsXG4gICAgdGVtcGxhdGVVcmw6ICcuL2VhYy5lZGl0LmNvbXBvbmVudC5odG1sJ1xufSlcbmV4cG9ydCBjbGFzcyBFYWNFZGl0Q29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0IHtcbiAgICBlbnRpdHk6IEVBQztcbiAgICBwYXRpZW50OiBQYXRpZW50O1xuICAgIHRvZGF5ID0gbW9tZW50KCk7XG4gICAgZGF0ZVJlZ2lzdHJhdGlvbjogTW9tZW50O1xuICAgIGVhYzFNaW46IE1vbWVudDtcbiAgICBlYWMyTWluOiBNb21lbnQ7XG4gICAgZWFjM01pbjogTW9tZW50O1xuICAgIHJlcGVhdFZMTWluOiBNb21lbnQ7XG4gICAgcmVwZWF0VkxNYXg6IE1vbWVudDtcbiAgICBpc1NhdmluZzogYm9vbGVhbiA9IGZhbHNlO1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBjbGluaWNTZXJ2aWNlOiBDbGluaWNTZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgZWFjU2VydmljZTogRWFjU2VydmljZSxcbiAgICAgICAgICAgICAgICBwcm90ZWN0ZWQgbm90aWZpY2F0aW9uOiBOb3RpZmljYXRpb25TZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByb3RlY3RlZCBhY3RpdmF0ZWRSb3V0ZTogQWN0aXZhdGVkUm91dGUsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBhcHBMb2FkZXJTZXJ2aWNlOiBBcHBMb2FkZXJTZXJ2aWNlKSB7XG4gICAgfVxuXG4gICAgY3JlYXRlRW50aXR5KCk6IEVBQyB7XG4gICAgICAgIHJldHVybiA8RUFDPnt9O1xuICAgIH1cblxuICAgIG5nT25Jbml0KCk6IHZvaWQge1xuICAgICAgICB0aGlzLmFjdGl2YXRlZFJvdXRlLmRhdGEuc3Vic2NyaWJlKCh7ZW50aXR5fSkgPT4ge1xuICAgICAgICAgICAgdGhpcy5lbnRpdHkgPSAhIWVudGl0eSAmJiBlbnRpdHkuYm9keSA/IGVudGl0eS5ib2R5IDogZW50aXR5O1xuXG4gICAgICAgICAgICBpZiAodGhpcy5lbnRpdHkgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgIHRoaXMuZW50aXR5ID0gdGhpcy5jcmVhdGVFbnRpdHkoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IHBhdGllbnRJZCA9IHRoaXMuYWN0aXZhdGVkUm91dGUuc25hcHNob3QucGFyYW1NYXAuZ2V0KCdwYXRpZW50SWQnKTtcbiAgICAgICAgICAgIHRoaXMuY2xpbmljU2VydmljZS5nZXRQYXRpZW50KHBhdGllbnRJZCkuc3Vic2NyaWJlKChyZXMpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmVudGl0eS5wYXRpZW50ID0gcmVzO1xuICAgICAgICAgICAgICAgIHRoaXMuZW50aXR5LmZhY2lsaXR5ID0gcmVzLmZhY2lsaXR5O1xuICAgICAgICAgICAgICAgIHRoaXMuZGF0ZVJlZ2lzdHJhdGlvbiA9IHJlcy5kYXRlUmVnaXN0cmF0aW9uO1xuICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlTWluRGF0ZXMocmVzLmlkLCBtb21lbnQoKSk7XG4gICAgICAgICAgICAgICAgaWYgKCF0aGlzLmVudGl0eS5pZCkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmVhY1NlcnZpY2UuZ2V0TGF0ZXN0QnlQYXRpZW50KHJlcy51dWlkKS5zdWJzY3JpYmUociA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmVudGl0eSA9IHIub2sgPyByLmJvZHkgOiB0aGlzLmNyZWF0ZUVudGl0eSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yZXBlYXRWTE1pbiA9IHRoaXMuZW50aXR5LmRhdGVFYWMzID8gdGhpcy5lbnRpdHkuZGF0ZUVhYzMuY2xvbmUoKS5hZGQoMSwgJ2RheScpIDpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmVudGl0eS5kYXRlTGFzdFZpcmFsTG9hZDtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZWFjMk1pbiA9IHRoaXMuZW50aXR5LmRhdGVFYWMxID8gdGhpcy5lbnRpdHkuZGF0ZUVhYzEuY2xvbmUoKS5hZGQoMiwgJ3dlZWsnKSA6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5lbnRpdHkuZGF0ZUxhc3RWaXJhbExvYWQ7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmVhYzNNaW4gPSB0aGlzLmVudGl0eS5kYXRlRWFjMiA/IHRoaXMuZW50aXR5LmRhdGVFYWMyLmNsb25lKCkuYWRkKDIsICd3ZWVrJykgOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZW50aXR5LmRhdGVMYXN0VmlyYWxMb2FkO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICB1cGRhdGVNaW5EYXRlcyhpZDogbnVtYmVyLCBkYXRlOiBNb21lbnQpIHtcbiAgICAgICAgdGhpcy5lYWNTZXJ2aWNlLmdldExhdGVzdFZpcmFsTG9hZEJ5UGF0aWVudChpZCwgZGF0ZSkucGlwZSh0YXAoKHI6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuZW50aXR5LmRhdGVMYXN0VmlyYWxMb2FkID0gbW9tZW50KHIubGFib3JhdG9yeS5kYXRlUmVzdWx0UmVjZWl2ZWQpO1xuICAgICAgICAgICAgICAgIHRoaXMuZW50aXR5Lmxhc3RWaXJhbExvYWQgPSByLnJlc3VsdDtcbiAgICAgICAgICAgICAgICB0aGlzLmVhYzFNaW4gPSB0aGlzLmVudGl0eS5kYXRlTGFzdFZpcmFsTG9hZC5jbG9uZSgpLmFkZCgxLCAnZGF5Jyk7XG4gICAgICAgICAgICAgICAgdGhpcy5lYWMyTWluID0gdGhpcy5lbnRpdHkuZGF0ZUVhYzEgPyB0aGlzLmVudGl0eS5kYXRlRWFjMS5jbG9uZSgpLmFkZCgyLCAnd2VlaycpIDpcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5lbnRpdHkuZGF0ZUxhc3RWaXJhbExvYWQ7XG4gICAgICAgICAgICAgICAgdGhpcy5lYWMzTWluID0gdGhpcy5lbnRpdHkuZGF0ZUVhYzIgPyB0aGlzLmVudGl0eS5kYXRlRWFjMi5jbG9uZSgpLmFkZCgyLCAnd2VlaycpIDpcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5lbnRpdHkuZGF0ZUxhc3RWaXJhbExvYWQ7XG4gICAgICAgICAgICAgICAgdGhpcy5yZXBlYXRWTE1pbiA9IHRoaXMuZW50aXR5LmRhdGVFYWMzID8gdGhpcy5lbnRpdHkuZGF0ZUVhYzMuY2xvbmUoKS5hZGQoMSwgJ2RheScpIDpcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5lbnRpdHkuZGF0ZUxhc3RWaXJhbExvYWQ7XG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycjogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5lbnRpdHkuZGF0ZUxhc3RWaXJhbExvYWQgPSBudWxsO1xuICAgICAgICAgICAgICAgIHRoaXMuZW50aXR5Lmxhc3RWaXJhbExvYWQgPSBudWxsO1xuICAgICAgICAgICAgICAgIHRoaXMuZWFjMU1pbiA9IHRoaXMuZW50aXR5LnBhdGllbnQuZGF0ZVJlZ2lzdHJhdGlvbi5jbG9uZSgpLmFkZCgxLCAnZGF5Jyk7XG4gICAgICAgICAgICAgICAgdGhpcy5lYWMyTWluID0gdGhpcy5lbnRpdHkuZGF0ZUVhYzEgPyB0aGlzLmVudGl0eS5kYXRlRWFjMS5jbG9uZSgpLmFkZCgyLCAnd2VlaycpIDpcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5lbnRpdHkuZGF0ZUxhc3RWaXJhbExvYWQ7XG4gICAgICAgICAgICAgICAgdGhpcy5lYWMzTWluID0gdGhpcy5lbnRpdHkuZGF0ZUVhYzIgPyB0aGlzLmVudGl0eS5kYXRlRWFjMi5jbG9uZSgpLmFkZCgyLCAnd2VlaycpIDpcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5lbnRpdHkuZGF0ZUxhc3RWaXJhbExvYWQ7XG4gICAgICAgICAgICAgICAgdGhpcy5yZXBlYXRWTE1pbiA9IHRoaXMuZW50aXR5LmRhdGVFYWMzID8gdGhpcy5lbnRpdHkuZGF0ZUVhYzMuY2xvbmUoKS5hZGQoMSwgJ2RheScpIDpcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5lbnRpdHkuZGF0ZUxhc3RWaXJhbExvYWQ7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgICAgICB9KSk7XG4gICAgfVxuXG4gICAgZGF0ZUVhYzFDaGFuZ2VkKGRhdGU6IE1vbWVudCkge1xuICAgICAgICB0aGlzLmVhYzJNaW4gPSBkYXRlLmNsb25lKCkuYWRkKDIsICd3ZWVrcycpO1xuICAgICAgICB0aGlzLnVwZGF0ZU1pbkRhdGVzKHRoaXMuZW50aXR5LnBhdGllbnQuaWQsIGRhdGUpO1xuICAgIH1cblxuICAgIGRhdGVFYWMyQ2hhbmdlZChkYXRlOiBNb21lbnQpIHtcbiAgICAgICAgdGhpcy5lYWMzTWluID0gZGF0ZS5jbG9uZSgpLmFkZCgyLCAnd2Vla3MnKTtcbiAgICB9XG5cbiAgICBkYXRlRWFjM0NoYW5nZWQoZGF0ZTogTW9tZW50KSB7XG4gICAgICAgIHRoaXMucmVwZWF0VkxNaW4gPSBkYXRlLmNsb25lKCkuYWRkKDEsICdkYXlzJyk7XG4gICAgICAgIHRoaXMucmVwZWF0VkxNYXggPSBkYXRlLmNsb25lKCkuYWRkKDYsICdtb250aHMnKTtcbiAgICB9XG5cbiAgICBzYXZlKCkge1xuICAgICAgICAvL3RoaXMuc3VibWl0QnV0dG9uLmRpc2FibGVkID0gdHJ1ZTtcbiAgICAgICAgLy90aGlzLnByb2dyZXNzQmFyLm1vZGUgPSAnaW5kZXRlcm1pbmF0ZSc7XG4gICAgICAgIHRoaXMuaXNTYXZpbmcgPSB0cnVlO1xuICAgICAgICB0aGlzLmFwcExvYWRlclNlcnZpY2Uub3BlbignU2F2aW5nIEVBQyBzZXNzaW9uLi4nKTtcbiAgICAgICAgaWYgKHRoaXMuZW50aXR5LmlkICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHRoaXMuc3Vic2NyaWJlVG9TYXZlUmVzcG9uc2UodGhpcy5lYWNTZXJ2aWNlLnVwZGF0ZSh0aGlzLmVudGl0eSkpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5zdWJzY3JpYmVUb1NhdmVSZXNwb25zZSh0aGlzLmVhY1NlcnZpY2UuY3JlYXRlKHRoaXMuZW50aXR5KSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcmV2aW91c1N0YXRlKCkge1xuICAgICAgICB3aW5kb3cuaGlzdG9yeS5iYWNrKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdWJzY3JpYmVUb1NhdmVSZXNwb25zZShyZXN1bHQ6IE9ic2VydmFibGU8SHR0cFJlc3BvbnNlPGFueT4+KSB7XG4gICAgICAgIHJlc3VsdC5zdWJzY3JpYmUoXG4gICAgICAgICAgICAocmVzOiBIdHRwUmVzcG9uc2U8YW55PikgPT4gdGhpcy5vblNhdmVTdWNjZXNzKHJlcy5ib2R5KSxcbiAgICAgICAgICAgIChyZXM6IEh0dHBFcnJvclJlc3BvbnNlKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5vblNhdmVFcnJvcigpO1xuICAgICAgICAgICAgICAgIHRoaXMub25FcnJvcihyZXMubWVzc2FnZSk7XG4gICAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIG9uU2F2ZVN1Y2Nlc3MocmVzdWx0OiBhbnkpIHtcbiAgICAgICAgdGhpcy5hcHBMb2FkZXJTZXJ2aWNlLmNsb3NlKCk7XG4gICAgICAgIHRoaXMuaXNTYXZpbmcgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5ub3RpZmljYXRpb24ub3BlblNuYWNrTWVzc2FnZSgnRUFDIHNlc3Npb24gc3VjY2Vzc2Z1bGx5IHNhdmVkJyk7XG4gICAgICAgIHRoaXMucHJldmlvdXNTdGF0ZSgpO1xuICAgIH1cblxuICAgIHByaXZhdGUgb25TYXZlRXJyb3IoKSB7XG4gICAgICAgIHRoaXMuaXNTYXZpbmcgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5hcHBMb2FkZXJTZXJ2aWNlLmNsb3NlKCk7XG4gICAgICAgIC8vdGhpcy5zdWJtaXRCdXR0b24uZGlzYWJsZWQgPSB0cnVlO1xuICAgICAgICB0aGlzLm5vdGlmaWNhdGlvbi5zaG93RXJyb3IoJ0Vycm9yIG9jY3VycmVkIHNhdmluZyBFQUMgc2Vzc2lvbjsgdHJ5IGFnYWluJyk7XG4gICAgICAgIC8vdGhpcy5wcm9ncmVzc0Jhci5tb2RlID0gJ2RldGVybWluYXRlJztcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgb25FcnJvcihlcnJvck1lc3NhZ2U6IHN0cmluZykge1xuICAgICAgICB0aGlzLmFwcExvYWRlclNlcnZpY2UuY2xvc2UoKTtcbiAgICAgICAgdGhpcy5ub3RpZmljYXRpb24uc2hvd0Vycm9yKGVycm9yTWVzc2FnZSk7XG4gICAgfVxuXG59XG4iXX0=